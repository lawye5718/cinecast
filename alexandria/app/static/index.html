<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alexandria Audiobook</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .container-wide { max-width: 85%; margin-left: auto; margin-right: auto; padding-left: 12px; padding-right: 12px; }
        .nav-link { cursor: pointer; }
        .log-window {
            background-color: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', Courier, monospace;
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .step-indicator {
            display: inline-block;
            width: 25px;
            height: 25px;
            background-color: #e9ecef;
            color: #6c757d;
            border-radius: 50%;
            text-align: center;
            line-height: 25px;
            margin-right: 10px;
            font-weight: bold;
        }
        .step-active { background-color: #0d6efd; color: white; }
        .voice-card { border-left: 4px solid #0d6efd; }
        /* Editor row expand/collapse */
        .chunk-expand-btn {
            border: none;
            background: none;
            padding: 2px 4px;
            cursor: pointer;
            color: #6c757d;
            font-size: 0.85em;
            transition: transform 0.2s ease;
        }
        .chunk-row.expanded .chunk-expand-btn {
            transform: rotate(180deg);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-book-open me-2"></i>Alexandria</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link active" data-tab="setup">1. Setup</a></li>
                    <li class="nav-item"><a class="nav-link" data-tab="script">2. Script</a></li>
                    <li class="nav-item"><a class="nav-link" data-tab="voices">3. Voices</a></li>
                    <li class="nav-item"><a class="nav-link" data-tab="designer">4. Designer</a></li>
                    <li class="nav-item"><a class="nav-link" data-tab="training">5. Training</a></li>
                    <li class="nav-item"><a class="nav-link" data-tab="dataset-builder">6. Dataset</a></li>
                    <li class="nav-item"><a class="nav-link" data-tab="editor">7. Editor</a></li>
                    <li class="nav-item"><a class="nav-link" data-tab="audio">8. Result</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-wide">

        <!-- Setup Tab -->
        <div id="setup-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h4><span class="step-indicator step-active">1</span>Configuration</h4>
                </div>
                <div class="card-body">
                    <form id="config-form">
                        <h5 class="mb-3">LLM Settings (Script Generation)</h5>
                        <div class="mb-3">
                            <label class="form-label">Base URL</label>
                            <input type="text" class="form-control" id="llm-url" placeholder="http://localhost:1234/v1">
                            <div class="form-text">URL for your OpenAI-compatible server (LM Studio, Ollama, etc.)</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">API Key</label>
                            <input type="text" class="form-control" id="llm-key" value="local">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Model Name</label>
                            <input type="text" class="form-control" id="llm-model" placeholder="local-model">
                        </div>

                        <h5 class="mb-3 mt-4">TTS Settings (Voice Generation)</h5>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label class="form-label">TTS Mode</label>
                                <select class="form-select" id="tts-mode" onchange="toggleTTSMode()">
                                    <option value="external">External Server</option>
                                    <option value="local">Local Model</option>
                                </select>
                                <div class="form-text">Local loads model in-process; External connects to a Gradio TTS server</div>
                            </div>
                            <div class="col-md-5" id="tts-url-group">
                                <label class="form-label">TTS Server URL</label>
                                <input type="text" class="form-control" id="tts-url" value="http://127.0.0.1:7860">
                                <div class="form-text">URL for the Qwen3-TTS Gradio server</div>
                            </div>
                            <div class="col-md-4" id="tts-device-group" style="display:none;">
                                <label class="form-label">Device</label>
                                <select class="form-select" id="tts-device">
                                    <option value="auto">Auto (best available)</option>
                                    <option value="cuda:0">CUDA GPU 0</option>
                                    <option value="cuda:1">CUDA GPU 1</option>
                                    <option value="cpu">CPU</option>
                                </select>
                                <div class="form-text">Device for local model inference</div>
                            </div>
                            <div class="col-md-3" id="tts-language-group">
                                <label class="form-label">Language</label>
                                <select class="form-select" id="tts-language">
                                    <option value="Auto">Auto (detect)</option>
                                    <option value="English" selected>English</option>
                                    <option value="Chinese">Chinese</option>
                                    <option value="French">French</option>
                                    <option value="German">German</option>
                                    <option value="Italian">Italian</option>
                                    <option value="Japanese">Japanese</option>
                                    <option value="Korean">Korean</option>
                                    <option value="Portuguese">Portuguese</option>
                                    <option value="Russian">Russian</option>
                                    <option value="Spanish">Spanish</option>
                                </select>
                                <div class="form-text">Language for TTS synthesis</div>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Parallel Workers</label>
                                <input type="number" class="form-control" id="parallel-workers" value="2" min="1">
                                <div class="form-text">Concurrent TTS requests</div>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Batch Seed</label>
                                <input type="number" class="form-control" id="batch-seed" placeholder="-1 (random)">
                                <div class="form-text">Seed for reproducibility</div>
                            </div>
                        </div>
                        <div class="row mb-3" id="tts-local-options" style="display:none;">
                            <div class="col-md-2">
                                <div class="form-check form-switch mt-4">
                                    <input class="form-check-input" type="checkbox" id="compile-codec">
                                    <label class="form-check-label" for="compile-codec">Compile Codec</label>
                                </div>
                                <div class="form-text">torch.compile the audio codec (~3-4x batch speed, slow first run)</div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-check form-switch mt-4">
                                    <input class="form-check-input" type="checkbox" id="batch-group-by-type">
                                    <label class="form-check-label" for="batch-group-by-type">Optimize Batch Order</label>
                                </div>
                                <div class="form-text">Group by voice type for GPU efficiency (disables sequential order)</div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-check form-switch mt-4">
                                    <input class="form-check-input" type="checkbox" id="sub-batch-enabled" checked>
                                    <label class="form-check-label" for="sub-batch-enabled">Sub-batching</label>
                                </div>
                                <div class="form-text">Split batches by text length to reduce padding waste</div>
                            </div>
                            <div class="col-md-2" id="sub-batch-min-group">
                                <label class="form-label">Min Sub-batch Size</label>
                                <input type="number" class="form-control" id="sub-batch-min-size" value="4" min="1">
                                <div class="form-text">Min chunks before splitting</div>
                            </div>
                            <div class="col-md-2" id="sub-batch-ratio-group">
                                <label class="form-label">Length Ratio</label>
                                <input type="number" class="form-control" id="sub-batch-ratio" value="5" min="1" step="0.5">
                                <div class="form-text">Max long/short ratio before split</div>
                            </div>
                            <div class="col-md-2" id="sub-batch-max-chars-group">
                                <label class="form-label">Max Chars/Batch</label>
                                <input type="number" class="form-control" id="sub-batch-max-chars" value="3000" min="500" step="500">
                                <div class="form-text">VRAM safety limit per sub-batch. Reduce if you encounter HIP OOM errors or crashes (especially with long reference audio)</div>
                            </div>
                            <div class="col-md-2" id="sub-batch-max-items-group">
                                <label class="form-label">Max Items/Batch</label>
                                <input type="number" class="form-control" id="sub-batch-max-items" value="0" min="0" step="1">
                                <div class="form-text">Hard cap on sequences per sub-batch (0 = auto from VRAM estimate)</div>
                            </div>
                        </div>

                        <h5 class="mb-3 mt-4">
                            <a class="text-decoration-none" data-bs-toggle="collapse" href="#promptSettings" role="button" aria-expanded="false">
                                <i class="fas fa-chevron-right me-2" id="prompt-chevron"></i>Prompt Settings (Advanced)
                            </a>
                        </h5>
                        <div class="collapse" id="promptSettings">
                            <h6 class="mb-3">Generation Settings</h6>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Chunk Size (characters)</label>
                                    <input type="number" class="form-control" id="chunk-size" value="3000" min="500">
                                    <div class="form-text">Size of text chunks sent to LLM (characters). Smaller = more precise, larger = more context.</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Max Tokens (response)</label>
                                    <input type="number" class="form-control" id="max-tokens" value="4096" min="256">
                                    <div class="form-text">Maximum tokens for LLM response. Increase if output is being truncated.</div>
                                </div>
                            </div>
                            <h6 class="mb-3">LLM Sampling Parameters</h6>
                            <div class="row mb-3">
                                <div class="col">
                                    <label class="form-label">Temperature</label>
                                    <input type="number" class="form-control" id="temperature" value="0.6" min="0" max="2" step="0.05">
                                    <div class="form-text">Randomness (0 = deterministic)</div>
                                </div>
                                <div class="col">
                                    <label class="form-label">Top P</label>
                                    <input type="number" class="form-control" id="top-p" value="0.8" min="0" max="1" step="0.05">
                                    <div class="form-text">Nucleus sampling threshold</div>
                                </div>
                                <div class="col">
                                    <label class="form-label">Top K</label>
                                    <input type="number" class="form-control" id="top-k" value="20" min="0" max="200" step="1">
                                    <div class="form-text">Top-K token filtering</div>
                                </div>
                                <div class="col">
                                    <label class="form-label">Min P</label>
                                    <input type="number" class="form-control" id="min-p" value="0" min="0" max="1" step="0.01">
                                    <div class="form-text">Minimum probability cutoff</div>
                                </div>
                                <div class="col">
                                    <label class="form-label">Presence Penalty</label>
                                    <input type="number" class="form-control" id="presence-penalty" value="0" min="-2" max="2" step="0.1">
                                    <div class="form-text">Penalize repeated topics</div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Banned Tokens</label>
                                <input type="text" class="form-control" id="banned-tokens" placeholder="e.g. <think>, <reasoning>">
                                <div class="form-text">Comma-separated tokens the LLM is forbidden from generating. Use to disable thinking mode (e.g. <code>&lt;think&gt;</code>).</div>
                            </div>
                            <div class="mb-3 form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="merge-narrators">
                                <label class="form-check-label" for="merge-narrators">Merge consecutive narrator lines</label>
                                <div class="form-text">During script review, combine adjacent NARRATOR entries that share the same instruct into a single longer entry. Disable for better per-line voice direction control.</div>
                            </div>
                            <hr>
                            <h6 class="mb-3">Prompt Customization</h6>
                            <div class="mb-3">
                                <label class="form-label">System Prompt</label>
                                <textarea class="form-control font-monospace" id="system-prompt" rows="12" style="font-size: 0.85em;"></textarea>
                                <div class="form-text">Instructions for the LLM on how to convert text to script. Defines output format, rules, and style guidelines.</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">User Prompt Template</label>
                                <textarea class="form-control font-monospace" id="user-prompt" rows="4" style="font-size: 0.85em;"></textarea>
                                <div class="form-text">Template for each chunk. Use <code>{context}</code> for chunk context and <code>{chunk}</code> for the text content.</div>
                            </div>
                            <button type="button" class="btn btn-outline-secondary btn-sm mb-3" onclick="resetPrompts()">
                                <i class="fas fa-undo me-1"></i>Reset to Defaults
                            </button>
                        </div>

                        <button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i>Save Configuration</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Script Tab -->
        <div id="script-tab" class="tab-content" style="display:none;">
            <div class="card">
                <div class="card-header">
                    <h4><span class="step-indicator step-active">2</span>Generate Script</h4>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <label class="form-label">Select Book/Novel (Text File)</label>
                        <input type="file" class="form-control" id="file-upload" accept=".txt,.md">
                        <div id="upload-status" class="mt-2"></div>
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-success btn-lg" id="btn-gen-script">
                            <i class="fas fa-magic me-2"></i>Generate Annotated Script
                        </button>
                        <button class="btn btn-outline-primary btn-lg" id="btn-review-script">
                            <i class="fas fa-check-double me-2"></i>Review Script
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="m-0">Saved Scripts</h5>
                </div>
                <div class="card-body">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="save-script-name" placeholder="Script name (e.g. The Great Gatsby)">
                        <button class="btn btn-outline-primary" onclick="saveScript()"><i class="fas fa-save me-1"></i>Save Current</button>
                    </div>
                    <div id="saved-scripts-list">
                        <p class="text-muted mb-0">No saved scripts yet.</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Generation Logs</div>
                <div class="card-body p-0">
                    <div id="script-logs" class="log-window"></div>
                </div>
            </div>
        </div>

        <!-- Voices Tab -->
        <div id="voices-tab" class="tab-content" style="display:none;">
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="m-0"><span class="step-indicator step-active">3</span>Voice Configuration</h4>
                    <span id="voice-save-status" class="text-muted small"></span>
                </div>
                <div class="card-body">
                    <p>Voices are detected from the generated script. Changes are saved automatically.</p>
                    <div id="voices-list"></div>
                </div>
            </div>

             <div class="card">
                <div class="card-header">Voice Parsing Logs</div>
                <div class="card-body p-0">
                    <div id="voices-logs" class="log-window" style="height: 150px;"></div>
                </div>
            </div>
        </div>

        <!-- Designer Tab -->
        <div id="designer-tab" class="tab-content" style="display:none;">
            <div class="card mb-3">
                <div class="card-header">
                    <h4><span class="step-indicator step-active">4</span>Voice Designer</h4>
                </div>
                <div class="card-body">
                    <p>Design new voices from text descriptions. Generated voices can be saved and used as clone sources in the Voices tab.</p>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Voice Description</label>
                            <textarea class="form-control" id="design-description" rows="3" placeholder="A warm, mature female voice with a British accent. Speaks clearly with gentle authority."></textarea>
                            <div class="form-text">Describe the voice characteristics you want</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Sample Text</label>
                            <textarea class="form-control" id="design-sample-text" rows="3" placeholder="The ancient library stood at the crossroads of two forgotten paths, its weathered stone walls covered in ivy.">The ancient library stood at the crossroads of two forgotten paths, its weathered stone walls covered in ivy that had been growing for centuries.</textarea>
                            <div class="form-text">Text to synthesize with the designed voice</div>
                        </div>
                    </div>

                    <div class="d-flex align-items-center gap-3 mb-3">
                        <button class="btn btn-primary" id="btn-design-preview" onclick="generateDesignPreview()">
                            <i class="fas fa-magic me-1"></i>Generate Preview
                        </button>
                        <span id="design-status" class="text-muted"></span>
                    </div>

                    <div id="design-preview-container" style="display:none;">
                        <div class="card bg-light mb-3">
                            <div class="card-body py-2">
                                <label class="form-label fw-bold mb-1">Preview</label>
                                <audio id="design-preview-audio" controls class="w-100"></audio>
                            </div>
                        </div>

                        <div class="row g-2 align-items-end">
                            <div class="col-md-4">
                                <label class="form-label">Voice Name</label>
                                <input type="text" class="form-control" id="design-voice-name" placeholder="e.g. Lady Narrator">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-success w-100" onclick="saveDesignedVoice()">
                                    <i class="fas fa-save me-1"></i>Save Voice
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="m-0">Saved Voices</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadDesignedVoices()"><i class="fas fa-sync me-1"></i>Refresh</button>
                </div>
                <div class="card-body">
                    <div id="designed-voices-list">
                        <p class="text-muted mb-0">No designed voices yet. Generate and save a preview above.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Training Tab -->
        <div id="training-tab" class="tab-content" style="display:none;">
            <div class="card mb-3">
                <div class="card-header">
                    <h4><span class="step-indicator step-active">5</span>LoRA Training</h4>
                </div>
                <div class="card-body">
                    <p>Train LoRA adapters on the Base model to create custom voice identities. Upload a dataset (ZIP with WAV files + metadata.jsonl), configure training, and run.</p>

                    <!-- Dataset Upload -->
                    <h5 class="mb-3">Dataset</h5>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="file" class="form-control" id="lora-dataset-file" accept=".zip">
                                <button class="btn btn-outline-primary" onclick="uploadLoraDataset()"><i class="fas fa-upload me-1"></i>Upload ZIP</button>
                            </div>
                            <div class="form-text">ZIP containing WAV files (24kHz mono) and metadata.jsonl with audio_filepath and text fields</div>
                        </div>
                        <div class="col-md-6">
                            <div id="lora-datasets-list" class="border rounded p-2" style="min-height: 60px;">
                                <span class="text-muted">No datasets uploaded yet.</span>
                            </div>
                        </div>
                    </div>

                    <!-- Build New Dataset -->
                    <div class="mb-3">
                        <button class="btn btn-outline-primary" onclick="document.querySelector('[data-tab=dataset-builder]').click();">
                            <i class="fas fa-flask me-1"></i>Build New Dataset
                        </button>
                        <span class="text-muted small ms-2">Open the Dataset Builder to create training datasets with per-line preview and generation.</span>
                    </div>

                    <hr>

                    <!-- Training Config -->
                    <h5 class="mb-3">Training Configuration</h5>
                    <div class="row g-3 mb-3">
                        <div class="col-md-3">
                            <label class="form-label">Adapter Name</label>
                            <input type="text" class="form-control" id="lora-adapter-name" placeholder="e.g. narrator_warm">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Dataset</label>
                            <select class="form-select" id="lora-dataset-select">
                                <option value="">-- Select dataset --</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Epochs</label>
                            <input type="number" class="form-control" id="lora-epochs" value="5" min="1">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Learning Rate</label>
                            <input type="text" class="form-control" id="lora-lr" value="5e-6">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Batch Size</label>
                            <input type="number" class="form-control" id="lora-batch-size" value="1" min="1">
                        </div>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-md-2">
                            <label class="form-label">LoRA Rank</label>
                            <input type="number" class="form-control" id="lora-rank" value="32" min="1">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">LoRA Alpha</label>
                            <input type="number" class="form-control" id="lora-alpha" value="128" min="1">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Grad Accum Steps</label>
                            <input type="number" class="form-control" id="lora-grad-accum" value="8" min="1">
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button class="btn btn-success btn-lg" id="btn-lora-train" onclick="startLoraTraining()">
                                <i class="fas fa-dumbbell me-1"></i>Start Training
                            </button>
                            <span id="lora-train-status" class="ms-3 text-muted"></span>
                        </div>
                    </div>

                    <!-- Settings Info Panel -->
                    <div class="card mb-3 border-info">
                        <div class="card-header py-2 bg-info bg-opacity-10 d-flex justify-content-between align-items-center" style="cursor:pointer;" onclick="this.parentElement.querySelector('.card-body').classList.toggle('d-none')">
                            <strong><i class="fas fa-info-circle me-1"></i>How Settings Affect LoRA Voice Quality</strong>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="card-body d-none small">
                            <dl class="row mb-0">
                                <dt class="col-sm-3">LoRA Rank</dt>
                                <dd class="col-sm-9">Controls adapter capacity. <strong>High rank (64+)</strong> captures voice identity strongly but can override the model's ability to follow instruct/style prompts, producing flat delivery. <strong>Low rank (8-16)</strong> preserves expressiveness and instruct-following but captures less voice detail. Start with 16-32 for a balance.</dd>
                                <dt class="col-sm-3">LoRA Alpha</dt>
                                <dd class="col-sm-9">Scaling factor for LoRA weights. Effective strength = alpha / rank. Higher alpha relative to rank means the adapter has more influence. A common starting point is alpha = 2x rank.</dd>
                                <dt class="col-sm-3">Epochs</dt>
                                <dd class="col-sm-9">Number of full passes over the dataset. <strong>Too few</strong>: voice identity won't converge. <strong>Too many</strong>: overfitting, stuttering, repetition artifacts. 15-30 epochs is a good range for 20+ samples.</dd>
                                <dt class="col-sm-3">Learning Rate</dt>
                                <dd class="col-sm-9">Step size for weight updates. Default 5e-6 is conservative. Higher (1e-5) trains faster but risks instability. Lower (1e-6) is safer for longer training runs.</dd>
                                <dt class="col-sm-3">Batch Size</dt>
                                <dd class="col-sm-9">Samples processed per step. Limited by VRAM. Batch 1 with gradient accumulation is typical for 24GB cards.</dd>
                                <dt class="col-sm-3">Grad Accum Steps</dt>
                                <dd class="col-sm-9">Simulates larger batches by accumulating gradients over N steps before updating. Effective batch = batch_size x grad_accum. Higher values give smoother training at the cost of speed.</dd>
                            </dl>
                            <hr class="my-2">
                            <p class="mb-0"><strong>Training data tip:</strong> For expressive voices, include samples with varied emotions (happy, sad, angry, calm). Neutral-only training data will produce a flat voice that resists instruct prompting.</p>
                        </div>
                    </div>

                    <!-- Training Progress -->
                    <div id="lora-progress-section" style="display:none;">
                        <hr>
                        <h5 class="mb-2">Training Progress</h5>
                        <div class="row g-3 mb-2">
                            <div class="col-md-4">
                                <div class="d-flex justify-content-between">
                                    <span>Epoch: <strong id="lora-epoch-display">0/0</strong></span>
                                    <span>Loss: <strong id="lora-loss-display">--</strong></span>
                                </div>
                                <div class="progress mt-1" style="height: 20px;">
                                    <div id="lora-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" style="width: 0%">0%</div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div id="lora-train-logs" class="log-window" style="height: 200px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trained Adapters -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="m-0">Trained Adapters</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadLoraModels()"><i class="fas fa-sync me-1"></i>Refresh</button>
                </div>
                <div class="card-body">
                    <div id="lora-models-list">
                        <p class="text-muted mb-0">No trained adapters yet.</p>
                    </div>

                    <!-- Test Voice Form -->
                    <div id="lora-test-form" class="mt-3 pt-3 border-top" style="display:none;">
                        <h6>Test Voice</h6>
                        <div class="row g-2 mb-2">
                            <div class="col-md-4">
                                <label class="form-label small">Adapter</label>
                                <select id="lora-test-adapter" class="form-select form-select-sm"></select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small">Text</label>
                                <input type="text" id="lora-test-text" class="form-control form-control-sm" value="The ancient library stood at the crossroads of two forgotten paths.">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small">Instruct</label>
                                <input type="text" id="lora-test-instruct" class="form-control form-control-sm" placeholder="e.g. Warm, gentle narration">
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-primary" onclick="runLoraTest()"><i class="fas fa-play me-1"></i>Generate</button>
                            <span id="lora-test-status" class="text-muted small"></span>
                        </div>
                        <div id="lora-test-audio" class="mt-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dataset Builder Tab -->
        <div id="dataset-builder-tab" class="tab-content" style="display:none;">
            <div class="card">
                <div class="card-header">
                    <h4><span class="step-indicator step-active">6</span>Dataset Builder</h4>
                    <p class="text-muted mb-0">Build LoRA training datasets with per-sample generation, preview, and re-generation.</p>
                </div>
                <div class="card-body">
                    <!-- Project Selector -->
                    <div class="d-flex align-items-center gap-2 mb-3">
                        <select class="form-select" id="dsb-project-select" style="max-width: 300px;" onchange="dsbOnProjectChange()">
                            <option value="">-- Select project --</option>
                        </select>
                        <button class="btn btn-primary btn-sm" onclick="dsbCreateProject()"><i class="fas fa-plus me-1"></i>New Dataset</button>
                        <button class="btn btn-outline-danger btn-sm" id="dsb-btn-delete-project" onclick="dsbDeleteProject()" style="display:none;"><i class="fas fa-trash me-1"></i>Delete</button>
                    </div>

                    <!-- Dataset Config (shown when project selected) -->
                    <div id="dsb-form-area" style="display:none;">
                    <div class="row g-3 mb-3">
                        <div class="col-md-9">
                            <label class="form-label">Root Voice Description</label>
                            <input type="text" class="form-control" id="dsb-description" placeholder="e.g. A male tenor with a steady, clean tone, light nasal resonance, and even delivery">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Global Seed</label>
                            <input type="number" class="form-control" id="dsb-global-seed" placeholder="Random" min="-1" value="">
                            <div class="text-muted" style="font-size: 0.7rem;">Empty = random. Same seed = same voice.</div>
                        </div>
                    </div>

                    <!-- Toolbar -->
                    <div class="d-flex align-items-center gap-2 mb-3">
                        <button class="btn btn-sm btn-outline-secondary" onclick="dsbAddRow()"><i class="fas fa-plus me-1"></i>Add Row</button>
                        <label class="btn btn-sm btn-outline-info mb-0">
                            <i class="fas fa-file-import me-1"></i>Import JSON
                            <input type="file" accept=".json" onchange="dsbImport(event)" style="display:none;">
                        </label>
                        <button class="btn btn-sm btn-outline-info" onclick="dsbExport()"><i class="fas fa-file-export me-1"></i>Export JSON</button>
                        <div class="ms-auto d-flex gap-2">
                            <button class="btn btn-sm btn-success" id="dsb-btn-gen-all" onclick="dsbGenerateAll(false)"><i class="fas fa-play me-1"></i>Generate Pending</button>
                            <button class="btn btn-sm btn-outline-success" id="dsb-btn-regen-all" onclick="dsbGenerateAll(true)"><i class="fas fa-redo me-1"></i>Regen All</button>
                            <button class="btn btn-sm btn-danger" id="dsb-btn-cancel" onclick="dsbCancel()" style="display:none;"><i class="fas fa-stop me-1"></i>Cancel</button>
                        </div>
                    </div>

                    <!-- Progress bar -->
                    <div class="progress mb-3" style="height: 22px; display: none;" id="dsb-progress-wrap">
                        <div id="dsb-progress-bar" class="progress-bar progress-bar-striped bg-success" role="progressbar" style="width: 0%">0%</div>
                    </div>

                    <!-- Spreadsheet table -->
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th width="4%">#</th>
                                    <th width="16%">Emotion / Style</th>
                                    <th width="34%">Text</th>
                                    <th width="7%">Seed</th>
                                    <th width="7%">Status</th>
                                    <th width="32%">Audio / Actions</th>
                                </tr>
                            </thead>
                            <tbody id="dsb-table-body">
                            </tbody>
                        </table>
                    </div>

                    <!-- Save section -->
                    <div class="card mt-3">
                        <div class="card-body d-flex align-items-center gap-3">
                            <button class="btn btn-primary" id="dsb-btn-save" onclick="dsbSave()"><i class="fas fa-save me-1"></i>Save as Training Dataset</button>
                            <div>
                                <label class="form-label mb-0 me-2">Reference Sample:</label>
                                <select class="form-select form-select-sm d-inline-block" id="dsb-ref-select" style="width: auto;">
                                    <option value="0">First completed sample</option>
                                </select>
                            </div>
                            <span id="dsb-save-status" class="text-muted small"></span>
                        </div>
                        <div class="text-muted small px-3 pb-2"><i class="fas fa-info-circle me-1"></i>The reference sample is used as the speaker embedding (<code>ref.wav</code>) during LoRA training. Pick a clear, representative line.</div>
                    </div>

                    <!-- Logs -->
                    <pre id="dsb-logs" class="bg-dark text-light p-2 rounded mt-3" style="max-height: 150px; overflow-y: auto; font-size: 0.8rem; display: none;"></pre>
                    </div><!-- /dsb-form-area -->
                </div>
            </div>
        </div>

        <!-- Editor Tab -->
        <div id="editor-tab" class="tab-content" style="display:none;">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                     <h4 class="m-0"><span class="step-indicator step-active">7</span>Audio Editor</h4>
                     <div class="d-flex gap-2">
                        <button class="btn btn-primary btn-sm" id="btn-play-seq" onclick="playSequence()"><i class="fas fa-play me-1"></i>Play Sequence</button>
                        <button class="btn btn-success btn-sm" id="btn-render-all" onclick="renderAll(false)"><i class="fas fa-layer-group me-1"></i>Render Pending</button>
                        <button class="btn btn-info btn-sm" id="btn-batch-fast" onclick="renderBatchFast(false)" title="Requires custom Qwen3-TTS with batch API"><i class="fas fa-bolt me-1"></i>Batch (Fast) <i class="fas fa-flask"></i></button>
                        <button class="btn btn-outline-success btn-sm" id="btn-regen-all" onclick="renderAll(true)"><i class="fas fa-redo me-1"></i>Regenerate All</button>
                        <button class="btn btn-danger btn-sm" id="btn-cancel-render" onclick="cancelRender()" style="display:none;"><i class="fas fa-stop me-1"></i>Cancel</button>
                        <button class="btn btn-warning btn-sm" id="btn-merge"><i class="fas fa-file-audio me-1"></i>Merge All</button>
                     </div>
                </div>
                <div class="card-body">
                     <!-- Full Progress Bar -->
                     <div class="progress mb-3" style="height: 25px;">
                         <div id="full-progress-bar" class="progress-bar progress-bar-striped bg-success" role="progressbar" style="width: 0%">0%</div>
                     </div>

                     <div class="table-responsive">
                         <table class="table table-bordered table-hover">
                             <thead>
                                 <tr>
                                     <th width="3%"></th>
                                     <th width="9%">Speaker</th>
                                     <th width="40%">Text</th>
                                     <th width="14%">Instruct</th>
                                     <th width="7%">Status</th>
                                     <th width="27%">Audio / Actions</th>
                                 </tr>
                             </thead>
                             <tbody id="chunks-table-body">
                                 <!-- Rows will be injected here -->
                             </tbody>
                         </table>
                     </div>
                </div>
            </div>
        </div>

        <!-- Audio Result Tab -->
        <div id="audio-tab" class="tab-content" style="display:none;">
            <div class="card">
                <div class="card-header">
                    <h4><span class="step-indicator step-active">8</span>Final Result</h4>
                </div>
                <div class="card-body">
                    <div id="audio-player-container" class="text-center" style="display:none;">
                        <h5>Your Audiobook</h5>
                        <audio id="main-audio" controls class="w-100 mt-2">
                            <source src="" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                        <a id="download-link" href="#" class="btn btn-outline-dark mt-3" download="audiobook.mp3">
                            <i class="fas fa-download me-2"></i>Download MP3
                        </a>
                        <button class="btn btn-outline-primary mt-3 ms-2" onclick="exportAudacity()">
                            <i class="fas fa-headphones me-2"></i>Export to Audacity
                        </button>
                        <span id="audacity-status" class="ms-2 mt-3 d-inline-block"></span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Generation Logs</div>
                <div class="card-body p-0">
                    <div id="audio-logs" class="log-window"></div>
                </div>
            </div>
        </div>

    </div>

    <!-- Toast container -->
    <div id="toast-container" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1090;"></div>

    <!-- Confirm modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body fs-6" id="confirmModalBody"></div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-secondary btn-sm" id="confirmModalCancel" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary btn-sm" id="confirmModalOk">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- Toast & Confirm utilities ---
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            const bgClass = type === 'success' ? 'bg-success' :
                           type === 'error' ? 'bg-danger' :
                           type === 'warning' ? 'bg-warning text-dark' : 'bg-info';
            const id = 'toast-' + Date.now();
            const html = `
                <div id="${id}" class="toast align-items-center text-white ${bgClass} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
            const el = document.getElementById(id);
            const toast = new bootstrap.Toast(el, { delay: duration });
            toast.show();
            el.addEventListener('hidden.bs.toast', () => el.remove());
        }

        function showConfirm(message) {
            return new Promise((resolve) => {
                const body = document.getElementById('confirmModalBody');
                body.textContent = message;
                const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
                const okBtn = document.getElementById('confirmModalOk');
                const cancelBtn = document.getElementById('confirmModalCancel');

                function cleanup() {
                    okBtn.removeEventListener('click', onOk);
                    cancelBtn.removeEventListener('click', onCancel);
                    document.getElementById('confirmModal').removeEventListener('hidden.bs.modal', onHidden);
                }
                let resolved = false;
                function onOk() { resolved = true; cleanup(); modal.hide(); resolve(true); }
                function onCancel() { resolved = true; cleanup(); modal.hide(); resolve(false); }
                function onHidden() { if (!resolved) { cleanup(); resolve(false); } }

                okBtn.addEventListener('click', onOk);
                cancelBtn.addEventListener('click', onCancel);
                document.getElementById('confirmModal').addEventListener('hidden.bs.modal', onHidden);
                modal.show();
            });
        }

        // --- Navigation ---
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                // Remove active class from all links
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                // Add active to clicked
                e.target.classList.add('active');

                // Hide all tabs
                document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
                // Show target tab
                const targetId = e.target.dataset.tab + '-tab';
                document.getElementById(targetId).style.display = 'block';

                // Trigger tab specific loads
                if (e.target.dataset.tab === 'editor') {
                    loadChunks();
                } else if (e.target.dataset.tab === 'voices') {
                    loadVoices();
                } else if (e.target.dataset.tab === 'designer') {
                    loadDesignedVoices();
                } else if (e.target.dataset.tab === 'training') {
                    loadLoraDatasets();
                    loadLoraModels();
                } else if (e.target.dataset.tab === 'dataset-builder') {
                    dsbLoadProjects(dsbCurrentProject);
                }
            });
        });

        // --- API Helpers ---
        const API = {
            _handleError: async (res) => {
                if (res.ok) return;
                try {
                    const body = await res.json();
                    throw new Error(body.detail || res.statusText);
                } catch (e) {
                    if (e.message) throw e;
                    throw new Error(res.statusText);
                }
            },
            get: async (url) => {
                const res = await fetch(url);
                await API._handleError(res);
                return res.json();
            },
            post: async (url, data) => {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                await API._handleError(res);
                return res.json();
            },
            upload: async (file) => {
                const formData = new FormData();
                formData.append('file', file);
                const res = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                await API._handleError(res);
                return res.json();
            }
        };

        // --- Setup Tab ---

        function toggleTTSMode() {
            const mode = document.getElementById('tts-mode').value;
            document.getElementById('tts-url-group').style.display = mode === 'external' ? '' : 'none';
            document.getElementById('tts-device-group').style.display = mode === 'local' ? '' : 'none';
            document.getElementById('tts-local-options').style.display = mode === 'local' ? '' : 'none';
        }

        async function loadConfig() {
            document.getElementById('chunk-size').value = 3000;
            document.getElementById('max-tokens').value = 4096;

            try {
                const config = await API.get('/api/config');
                document.getElementById('llm-url').value = config.llm.base_url;
                document.getElementById('llm-key').value = config.llm.api_key;
                document.getElementById('llm-model').value = config.llm.model_name;
                document.getElementById('tts-mode').value = config.tts.mode || 'external';
                document.getElementById('tts-url').value = config.tts.url || 'http://127.0.0.1:7860';
                document.getElementById('tts-device').value = config.tts.device || 'auto';
                document.getElementById('tts-language').value = config.tts.language || 'English';
                document.getElementById('parallel-workers').value = config.tts.parallel_workers || 2;
                if (config.tts.batch_seed != null) {
                    document.getElementById('batch-seed').value = config.tts.batch_seed;
                }
                document.getElementById('compile-codec').checked = !!config.tts.compile_codec;
                document.getElementById('batch-group-by-type').checked = !!config.tts.batch_group_by_type;
                document.getElementById('sub-batch-enabled').checked = config.tts.sub_batch_enabled !== false;
                if (config.tts.sub_batch_min_size != null) {
                    document.getElementById('sub-batch-min-size').value = config.tts.sub_batch_min_size;
                }
                if (config.tts.sub_batch_ratio != null) {
                    document.getElementById('sub-batch-ratio').value = config.tts.sub_batch_ratio;
                }
                if (config.tts.sub_batch_max_chars != null) {
                    document.getElementById('sub-batch-max-chars').value = config.tts.sub_batch_max_chars;
                }
                if (config.tts.sub_batch_max_items != null) {
                    document.getElementById('sub-batch-max-items').value = config.tts.sub_batch_max_items;
                }
                toggleTTSMode();

                // Load custom prompts if they exist and are non-empty
                if (config.prompts) {
                    if (config.prompts.system_prompt) {
                        document.getElementById('system-prompt').value = config.prompts.system_prompt;
                    }
                    if (config.prompts.user_prompt) {
                        document.getElementById('user-prompt').value = config.prompts.user_prompt;
                    }
                }

                // Load generation settings
                if (config.generation) {
                    if (config.generation.chunk_size) {
                        document.getElementById('chunk-size').value = config.generation.chunk_size;
                    }
                    if (config.generation.max_tokens) {
                        document.getElementById('max-tokens').value = config.generation.max_tokens;
                    }
                    if (config.generation.temperature != null) {
                        document.getElementById('temperature').value = config.generation.temperature;
                    }
                    if (config.generation.top_p != null) {
                        document.getElementById('top-p').value = config.generation.top_p;
                    }
                    if (config.generation.top_k != null) {
                        document.getElementById('top-k').value = config.generation.top_k;
                    }
                    if (config.generation.min_p != null) {
                        document.getElementById('min-p').value = config.generation.min_p;
                    }
                    if (config.generation.presence_penalty != null) {
                        document.getElementById('presence-penalty').value = config.generation.presence_penalty;
                    }
                    if (config.generation.banned_tokens && config.generation.banned_tokens.length > 0) {
                        document.getElementById('banned-tokens').value = config.generation.banned_tokens.join(', ');
                    }
                    document.getElementById('merge-narrators').checked = !!config.generation.merge_narrators;
                }

                // Show previously loaded file
                if (config.current_file) {
                    document.getElementById('upload-status').innerHTML =
                        `<span class="text-success"><i class="fas fa-check me-1"></i>Loaded: ${config.current_file}</span>`;
                }
            } catch (e) {
                console.error("Failed to load config", e);
            }
        }

        // Reset prompts and generation settings to factory defaults
        window.resetPrompts = async () => {
            try {
                const defaults = await API.get('/api/default_prompts');
                document.getElementById('system-prompt').value = defaults.system_prompt;
                document.getElementById('user-prompt').value = defaults.user_prompt;
            } catch (e) {
                console.error("Failed to fetch default prompts", e);
                showToast("Failed to load default prompts from server.", 'error');
            }
            document.getElementById('chunk-size').value = 3000;
            document.getElementById('max-tokens').value = 4096;
            document.getElementById('temperature').value = 0.6;
            document.getElementById('top-p').value = 0.8;
            document.getElementById('top-k').value = 20;
            document.getElementById('min-p').value = 0;
            document.getElementById('presence-penalty').value = 0;
            document.getElementById('banned-tokens').value = '';
            document.getElementById('merge-narrators').checked = false;
        };

        // Toggle chevron on collapse
        document.getElementById('promptSettings')?.addEventListener('show.bs.collapse', () => {
            document.getElementById('prompt-chevron').classList.replace('fa-chevron-right', 'fa-chevron-down');
        });
        document.getElementById('promptSettings')?.addEventListener('hide.bs.collapse', () => {
            document.getElementById('prompt-chevron').classList.replace('fa-chevron-down', 'fa-chevron-right');
        });

        document.getElementById('config-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            let chunkSize = parseInt(document.getElementById('chunk-size').value) || 3000;

            // Validate parallel workers
            let parallelWorkers = parseInt(document.getElementById('parallel-workers').value) || 2;
            parallelWorkers = Math.max(1, parallelWorkers);
            document.getElementById('parallel-workers').value = parallelWorkers;

            const config = {
                llm: {
                    base_url: document.getElementById('llm-url').value,
                    api_key: document.getElementById('llm-key').value,
                    model_name: document.getElementById('llm-model').value
                },
                tts: {
                    mode: document.getElementById('tts-mode').value,
                    url: document.getElementById('tts-url').value,
                    device: document.getElementById('tts-device').value,
                    language: document.getElementById('tts-language').value,
                    parallel_workers: parallelWorkers,
                    batch_seed: document.getElementById('batch-seed').value ? parseInt(document.getElementById('batch-seed').value) : null,
                    compile_codec: document.getElementById('compile-codec').checked,
                    batch_group_by_type: document.getElementById('batch-group-by-type').checked,
                    sub_batch_enabled: document.getElementById('sub-batch-enabled').checked,
                    sub_batch_min_size: parseInt(document.getElementById('sub-batch-min-size').value) || 4,
                    sub_batch_ratio: parseFloat(document.getElementById('sub-batch-ratio').value) || 5,
                    sub_batch_max_chars: parseInt(document.getElementById('sub-batch-max-chars').value) || 3000,
                    sub_batch_max_items: parseInt(document.getElementById('sub-batch-max-items').value) || 0
                },
                prompts: {
                    system_prompt: document.getElementById('system-prompt').value,
                    user_prompt: document.getElementById('user-prompt').value
                },
                generation: {
                    chunk_size: chunkSize,
                    max_tokens: parseInt(document.getElementById('max-tokens').value) || 4096,
                    temperature: parseFloat(document.getElementById('temperature').value),
                    top_p: parseFloat(document.getElementById('top-p').value),
                    top_k: parseInt(document.getElementById('top-k').value),
                    min_p: parseFloat(document.getElementById('min-p').value),
                    presence_penalty: parseFloat(document.getElementById('presence-penalty').value),
                    banned_tokens: document.getElementById('banned-tokens').value
                        ? document.getElementById('banned-tokens').value.split(',').map(t => t.trim()).filter(t => t)
                        : [],
                    merge_narrators: document.getElementById('merge-narrators').checked
                }
            };
            try {
                await API.post('/api/config', config);
                showToast('Configuration Saved!', 'success');
            } catch (e) {
                showToast('Error saving config: ' + e.message, 'error');
            }
        });

        // --- Script Tab ---
        document.getElementById('file-upload').addEventListener('change', async () => {
            const fileInput = document.getElementById('file-upload');
            const statusEl = document.getElementById('upload-status');
            if (fileInput.files.length === 0) return;

            statusEl.innerHTML = '<span class="text-info"><i class="fas fa-spinner fa-spin me-1"></i>Loading file...</span>';
            try {
                const res = await API.upload(fileInput.files[0]);
                statusEl.innerHTML = `<span class="text-success"><i class="fas fa-check me-1"></i>Loaded: ${res.filename}</span>`;
            } catch (e) {
                statusEl.innerHTML = `<span class="text-danger"><i class="fas fa-times me-1"></i>Failed to load file: ${e.message}</span>`;
            }
        });

        document.getElementById('btn-gen-script').addEventListener('click', async () => {
            const fileInput = document.getElementById('file-upload');
            const statusEl = document.getElementById('upload-status');

            // Check if a file has been loaded (status shows success) or if one was previously uploaded
            const hasLoadedFile = statusEl.innerHTML.includes('text-success');

            if (!hasLoadedFile && fileInput.files.length === 0) {
                statusEl.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Please select a text file first using the file picker above.</span>';
                return;
            }

            try {
                await API.post('/api/generate_script', {});
                pollLogs('script', 'script-logs');
            } catch (e) {
                const detail = e.message || 'Unknown error';
                if (detail.includes('No input file')) {
                    statusEl.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>No file loaded. Please select a text file first.</span>';
                } else {
                    statusEl.innerHTML = `<span class="text-danger"><i class="fas fa-times me-1"></i>${detail}</span>`;
                }
            }
        });

        document.getElementById('btn-review-script').addEventListener('click', async () => {
            try {
                await API.post('/api/review_script', {});
                pollLogs('review', 'script-logs');
            } catch (e) {
                showToast("Failed to start review: " + e.message, 'error');
            }
        });

        // --- Voices Tab ---
        const AVAILABLE_VOICES = ["Aiden", "Dylan", "Eric", "Ono_anna", "Ryan", "Serena", "Sohee", "Uncle_fu", "Vivian"];

        function createVoiceCard(voice, index) {
            const config = voice.config || {};
            const voiceType = config.type || 'custom';

            return `
                <div class="card voice-card mb-3" data-voice="${voice.name}">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <h5 class="card-title">${voice.name}</h5>
                            </div>
                            <div class="col-md-9">
                                <div class="mb-2">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input voice-type" type="radio" name="type_${index}" value="custom" ${voiceType === 'custom' ? 'checked' : ''} onchange="toggleVoiceType(this)">
                                        <label class="form-check-label">Custom Voice</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input voice-type" type="radio" name="type_${index}" value="builtin_lora" ${voiceType === 'builtin_lora' ? 'checked' : ''} onchange="toggleVoiceType(this)">
                                        <label class="form-check-label">Built-in Voice</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input voice-type" type="radio" name="type_${index}" value="clone" ${voiceType === 'clone' ? 'checked' : ''} onchange="toggleVoiceType(this)">
                                        <label class="form-check-label">Voice Clone</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input voice-type" type="radio" name="type_${index}" value="lora" ${voiceType === 'lora' ? 'checked' : ''} onchange="toggleVoiceType(this)">
                                        <label class="form-check-label">LoRA Voice</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input voice-type" type="radio" name="type_${index}" value="design" ${voiceType === 'design' ? 'checked' : ''} onchange="toggleVoiceType(this)">
                                        <label class="form-check-label">Voice Design</label>
                                    </div>
                                </div>

                                <!-- Custom Options -->
                                <div class="custom-opts" style="display: ${voiceType === 'custom' ? 'block' : 'none'}">
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <select class="form-select voice-select">
                                                ${AVAILABLE_VOICES.map(v => `<option value="${v}" ${config.voice === v ? 'selected' : ''}>${v}</option>`).join('')}
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <input type="text" class="form-control character-style" placeholder="Character style (e.g. refined aristocratic tone, heavy Scottish accent)" value="${config.character_style || config.default_style || ''}">
                                        </div>
                                    </div>
                                </div>

                                <!-- Built-in LoRA Options -->
                                <div class="builtin-lora-opts" style="display: ${voiceType === 'builtin_lora' ? 'block' : 'none'}">
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <select class="form-select builtin-lora-select">
                                                <option value="">-- Select built-in voice --</option>
                                                ${(() => {
                                                    const models = (window._loraModelsCache || []).filter(m => m.builtin);
                                                    const males = models.filter(m => m.gender === 'male');
                                                    const females = models.filter(m => m.gender === 'female');
                                                    let html = '';
                                                    if (males.length) {
                                                        html += '<optgroup label="Male">';
                                                        html += males.map(m => `<option value="${m.id}" ${config.adapter_id === m.id ? 'selected' : ''}>${m.name}  ${m.description || ''}</option>`).join('');
                                                        html += '</optgroup>';
                                                    }
                                                    if (females.length) {
                                                        html += '<optgroup label="Female">';
                                                        html += females.map(m => `<option value="${m.id}" ${config.adapter_id === m.id ? 'selected' : ''}>${m.name}  ${m.description || ''}</option>`).join('');
                                                        html += '</optgroup>';
                                                    }
                                                    return html;
                                                })()}
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <input type="text" class="form-control builtin-lora-style" placeholder="Character style (e.g. refined aristocratic tone, heavy Scottish accent)" value="${voiceType === 'builtin_lora' ? (config.character_style || '') : ''}">
                                        </div>
                                    </div>
                                </div>

                                <!-- Clone Options -->
                                <div class="clone-opts" style="display: ${voiceType === 'clone' ? 'block' : 'none'}">
                                    <div class="row g-2 mb-2">
                                        <div class="col-md-6">
                                            <select class="form-select designed-voice-select" onchange="onDesignedVoiceSelect(this)">
                                                <option value="">-- Select designed voice or enter manually --</option>
                                                ${(window._designedVoicesCache || []).map(v => `<option value="${v.id}" ${config.ref_audio && config.ref_audio.includes(v.filename) ? 'selected' : ''}>${v.name}</option>`).join('')}
                                                <option value="__manual__" ${config.ref_audio && !(window._designedVoicesCache || []).some(v => config.ref_audio.includes(v.filename)) && config.ref_audio ? 'selected' : ''}>Custom path...</option>
                                            </select>
                                        </div>
                                    </div>
                                    <input type="text" class="form-control ref-text mb-2" placeholder="Reference Text" value="${config.ref_text || ''}">
                                    <input type="text" class="form-control ref-audio" placeholder="Path to audio file" value="${config.ref_audio || ''}" ${config.ref_audio && (window._designedVoicesCache || []).some(v => config.ref_audio.includes(v.filename)) ? 'readonly' : ''}>
                                </div>

                                <!-- LoRA Options -->
                                <div class="lora-opts" style="display: ${voiceType === 'lora' ? 'block' : 'none'}">
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <select class="form-select lora-adapter-select">
                                                <option value="">-- Select trained adapter --</option>
                                                ${(window._loraModelsCache || []).map(m => `<option value="${m.id}" ${config.adapter_id === m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <input type="text" class="form-control lora-character-style" placeholder="Character style (e.g. refined aristocratic tone, heavy Scottish accent)" value="${voiceType === 'lora' ? (config.character_style || '') : ''}">
                                        </div>
                                    </div>
                                </div>

                                <!-- Voice Design Options -->
                                <div class="design-opts" style="display: ${voiceType === 'design' ? 'block' : 'none'}">
                                    <input type="text" class="form-control design-description mb-1" placeholder="Base voice description (e.g. Young strong soldier)" value="${config.description || ''}">
                                    <span class="text-muted small">Per-line instruct is appended to this description as delivery/emotion direction</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        window.toggleVoiceType = (radio) => {
            const card = radio.closest('.card-body');
            card.querySelector('.custom-opts').style.display = radio.value === 'custom' ? 'block' : 'none';
            card.querySelector('.builtin-lora-opts').style.display = radio.value === 'builtin_lora' ? 'block' : 'none';
            card.querySelector('.clone-opts').style.display = radio.value === 'clone' ? 'block' : 'none';
            card.querySelector('.lora-opts').style.display = radio.value === 'lora' ? 'block' : 'none';
            card.querySelector('.design-opts').style.display = radio.value === 'design' ? 'block' : 'none';
            debouncedSaveVoices();
        };

        async function loadVoices() {
            // Refresh designed voices cache so clone dropdown is populated
            try {
                window._designedVoicesCache = await API.get('/api/voice_design/list');
            } catch (e) { /* ignore if designer not available */ }
            // Refresh LoRA models cache so adapter dropdown is populated
            try {
                window._loraModelsCache = await API.get('/api/lora/models');
            } catch (e) { /* ignore if no adapters */ }

            const voices = await API.get('/api/voices');
            const container = document.getElementById('voices-list');
            if (voices.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No voices found. Generate a script first.</div>';
                return;
            }
            container.innerHTML = voices.map((v, i) => createVoiceCard(v, i)).join('');

            // If any voice has no saved config, save defaults immediately
            if (voices.some(v => !v.config || Object.keys(v.config).length === 0)) {
                debouncedSaveVoices();
            }
        }

        function collectVoiceConfig() {
            const cards = document.querySelectorAll('.voice-card');
            const config = {};

            cards.forEach(card => {
                const name = card.dataset.voice;
                const type = card.querySelector('.voice-type:checked').value;

                if (type === 'custom') {
                    config[name] = {
                        type: 'custom',
                        voice: card.querySelector('.voice-select').value,
                        character_style: card.querySelector('.character-style').value,
                        seed: "-1"
                    };
                } else if (type === 'clone') {
                    config[name] = {
                        type: 'clone',
                        ref_text: card.querySelector('.ref-text').value,
                        ref_audio: card.querySelector('.ref-audio').value,
                        seed: "-1"
                    };
                } else if (type === 'builtin_lora') {
                    const adapterId = card.querySelector('.builtin-lora-select').value;
                    const adapterEntry = (window._loraModelsCache || []).find(m => m.id === adapterId);
                    config[name] = {
                        type: 'builtin_lora',
                        adapter_id: adapterId,
                        adapter_path: adapterEntry?.adapter_path || '',
                        character_style: card.querySelector('.builtin-lora-style').value,
                        seed: "-1"
                    };
                } else if (type === 'lora') {
                    const adapterId = card.querySelector('.lora-adapter-select').value;
                    const adapterEntry = (window._loraModelsCache || []).find(m => m.id === adapterId);
                    config[name] = {
                        type: 'lora',
                        adapter_id: adapterId,
                        adapter_path: adapterEntry?.adapter_path || (adapterId ? `lora_models/${adapterId}` : ''),
                        character_style: card.querySelector('.lora-character-style').value,
                        seed: "-1"
                    };
                } else if (type === 'design') {
                    config[name] = {
                        type: 'design',
                        description: card.querySelector('.design-description').value,
                        seed: "-1"
                    };
                }
            });
            return config;
        }

        let _voiceSaveTimer = null;
        function debouncedSaveVoices() {
            const statusEl = document.getElementById('voice-save-status');
            statusEl.innerHTML = '<i class="fas fa-circle text-warning" style="font-size:0.5em;"></i> unsaved';
            clearTimeout(_voiceSaveTimer);
            _voiceSaveTimer = setTimeout(async () => {
                const cards = document.querySelectorAll('.voice-card');
                if (cards.length === 0) return;
                try {
                    const config = collectVoiceConfig();
                    await API.post('/api/save_voice_config', config);
                    statusEl.innerHTML = '<i class="fas fa-check text-success me-1"></i>saved';
                    setTimeout(() => { statusEl.innerHTML = ''; }, 2000);
                } catch (e) {
                    statusEl.innerHTML = '<i class="fas fa-times text-danger me-1"></i>save failed';
                }
            }, 800);
        }

        // Auto-save on any change inside the voices list
        document.getElementById('voices-list').addEventListener('change', () => {
            debouncedSaveVoices();
        });
        document.getElementById('voices-list').addEventListener('input', () => {
            debouncedSaveVoices();
        });

        // --- Editor Tab ---
        let isPlayingSequence = false;
        let isRenderingAll = false;
        let cachedChunks = []; // Cache to track changes

        // Check if any audio is currently playing
        function isAudioPlaying() {
            const audios = document.querySelectorAll('audio');
            for (const audio of audios) {
                if (!audio.paused && !audio.ended) return true;
            }
            return false;
        }

        // Update only changed rows instead of full redraw
        function updateChunkRow(chunk) {
            const tr = document.querySelector(`tr[data-id="${chunk.id}"]`);
            if (!tr) return false;

            const statusColor = chunk.status === 'done' ? 'success' :
                              chunk.status === 'generating' ? 'warning' :
                              chunk.status === 'error' ? 'danger' : 'secondary';

            // Update status badge
            const badge = tr.querySelector('.badge');
            if (badge) {
                badge.className = `badge bg-${statusColor}`;
                badge.innerText = chunk.status;
            }

            // Update action area (button/progress)
            const actionContainer = tr.querySelector('.d-flex');
            if (actionContainer) {
                const existingBtn = actionContainer.querySelector('button');
                const existingProgress = actionContainer.querySelector('.progress');

                if (chunk.status === 'generating') {
                    if (existingBtn && !existingProgress) {
                        const progressBar = document.createElement('div');
                        progressBar.className = 'progress';
                        progressBar.style.width = '100px';
                        progressBar.style.height = '20px';
                        progressBar.innerHTML = '<div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" role="progressbar" style="width: 100%"></div>';
                        actionContainer.replaceChild(progressBar, existingBtn);
                    }
                } else {
                    if (existingProgress && !existingBtn) {
                        const btn = document.createElement('button');
                        btn.className = 'btn btn-sm btn-primary';
                        btn.onclick = () => generateChunk(chunk.id);
                        btn.innerHTML = '<i class="fas fa-play"></i> Gen';
                        actionContainer.replaceChild(btn, existingProgress);
                    }
                }

                // Update audio player when status is done - always refresh src to bust cache
                if (chunk.status === 'done' && chunk.audio_path) {
                    const existingAudio = actionContainer.querySelector('audio');
                    const existingNoAudio = actionContainer.querySelector('.text-muted');
                    const newSrc = `/${chunk.audio_path}?t=${Date.now()}`;

                    if (existingNoAudio) {
                        // No audio element yet, create one
                        const audioHtml = `<audio class="chunk-audio" data-id="${chunk.id}" controls src="${newSrc}" style="width: 200px; height: 30px;" onplay="stopOthers(${chunk.id})"></audio>`;
                        existingNoAudio.outerHTML = audioHtml;
                    } else if (existingAudio) {
                        // Audio exists - just update the src with new cache-busting timestamp
                        // This forces browser to fetch the regenerated file
                        existingAudio.src = newSrc;
                        existingAudio.load(); // Force reload
                    }
                }
            }
            return true;
        }

        async function loadChunks(forceFullRedraw = false) {
            const tbody = document.getElementById('chunks-table-body');

            // Show loading only if empty
            if (tbody.children.length === 0 || (tbody.children.length === 1 && tbody.children[0].children.length === 1)) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Loading chunks...</td></tr>';
                forceFullRedraw = true;
            }

            try {
                const chunks = await API.get('/api/chunks');
                if (chunks.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No chunks found. Please generate script first.</td></tr>';
                    cachedChunks = [];
                    return;
                }

                // Update Full Progress Bar
                const completed = chunks.filter(c => c.status === 'done').length;
                const total = chunks.length;
                const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
                const progressBar = document.getElementById('full-progress-bar');
                if (progressBar) {
                    progressBar.style.width = `${percentage}%`;
                    progressBar.innerText = `${percentage}% (${completed}/${total})`;
                }

                // Skip redraw if playing audio (unless forced)
                if (!forceFullRedraw && (isPlayingSequence || isAudioPlaying())) {
                    // Only update status badges and progress indicators
                    chunks.forEach(chunk => updateChunkRow(chunk));
                    cachedChunks = chunks;

                    // Continue polling if generating
                    if (chunks.some(c => c.status === 'generating')) {
                        setTimeout(() => loadChunks(false), 2000);
                    }
                    return;
                }

                // Check if we can do incremental update
                const canIncrement = !forceFullRedraw &&
                                    cachedChunks.length === chunks.length &&
                                    tbody.children.length === chunks.length;

                if (canIncrement) {
                    // Incremental update - only update changed rows
                    chunks.forEach((chunk, i) => {
                        const cached = cachedChunks[i];
                        if (!cached || cached.status !== chunk.status || cached.audio_path !== chunk.audio_path) {
                            updateChunkRow(chunk);
                        }
                    });
                } else {
                    // Full redraw needed
                    tbody.innerHTML = chunks.map(chunk => {
                        const statusColor = chunk.status === 'done' ? 'success' :
                                          chunk.status === 'generating' ? 'warning' :
                                          chunk.status === 'error' ? 'danger' : 'secondary';

                        const audioPlayer = chunk.audio_path ?
                            `<audio class="chunk-audio" data-id="${chunk.id}" controls src="/${chunk.audio_path}?t=${Date.now()}" style="width: 200px; height: 30px;" onplay="stopOthers(${chunk.id})"></audio>` :
                            '<span class="text-muted small">No audio</span>';

                        const actionArea = chunk.status === 'generating' ?
                            `<div class="progress" style="width: 100px; height: 20px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" role="progressbar" style="width: 100%"></div>
                             </div>` :
                            `<button class="btn btn-sm btn-primary" onclick="generateChunk(${chunk.id})"><i class="fas fa-play"></i> Gen</button>`;

                        return `
                            <tr data-id="${chunk.id}" class="chunk-row">
                                <td class="text-center align-middle" style="white-space:nowrap;">
                                    <button class="chunk-expand-btn" onclick="toggleChunkExpand(this)" title="Expand/collapse"><i class="fas fa-chevron-down"></i></button><button class="chunk-expand-btn" onclick="insertChunkAfter(${chunk.id})" title="Insert line below"><i class="fas fa-plus"></i></button><button class="chunk-expand-btn" onclick="deleteChunk(${chunk.id})" title="Delete line"><i class="fas fa-trash" style="color:#dc3545;"></i></button>
                                </td>
                                <td><input type="text" class="form-control form-control-sm" value="${chunk.speaker}" onchange="updateChunk(${chunk.id}, 'speaker', this.value)"></td>
                                <td><textarea class="form-control form-control-sm chunk-text" rows="2" onchange="updateChunk(${chunk.id}, 'text', this.value)">${chunk.text}</textarea></td>
                                <td><textarea class="form-control form-control-sm chunk-instruct" rows="2" onchange="updateChunk(${chunk.id}, 'instruct', this.value)" title="Short TTS direction (3-8 words)">${chunk.instruct || ''}</textarea></td>
                                <td><span class="badge bg-${statusColor}">${chunk.status}</span></td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        ${actionArea}
                                        ${audioPlayer}
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }

                cachedChunks = chunks;

                // If any chunk is generating, poll (without full redraw)
                if (chunks.some(c => c.status === 'generating')) {
                    setTimeout(() => loadChunks(false), 2000);
                }

            } catch (e) {
                console.error("Error loading chunks:", e);
            }
        }

        window.toggleChunkExpand = (btn) => {
            const row = btn.closest('tr');
            const expanding = !row.classList.contains('expanded');
            row.classList.toggle('expanded');

            row.querySelectorAll('.chunk-text, .chunk-instruct').forEach(ta => {
                if (expanding) {
                    // Auto-size to content
                    ta.style.height = 'auto';
                    ta.style.height = ta.scrollHeight + 'px';
                    ta.style.overflow = 'visible';
                } else {
                    // Collapse back to 2 rows
                    ta.style.height = '';
                    ta.style.overflow = '';
                }
            });
        };

        window.insertChunkAfter = async (id) => {
            try {
                await API.post(`/api/chunks/${id}/insert`, {});
                await loadChunks(true);
            } catch (e) {
                showToast('Failed to insert line: ' + e.message, 'error');
            }
        };

        let _lastDeleted = null;
        let _undoTimer = null;

        window.deleteChunk = async (id) => {
            try {
                const res = await fetch(`/api/chunks/${id}`, { method: 'DELETE' });
                await API._handleError(res);
                const data = await res.json();

                // Store for undo
                _lastDeleted = { chunk: data.deleted, at_index: id };
                clearTimeout(_undoTimer);

                // Show toast with undo action
                const toastId = 'toast-undo-' + Date.now();
                const container = document.getElementById('toast-container');
                container.insertAdjacentHTML('beforeend', `
                    <div id="${toastId}" class="toast align-items-center text-white bg-warning border-0" role="alert">
                        <div class="d-flex">
                            <div class="toast-body text-dark">
                                Line deleted (${data.deleted.speaker}: "${(data.deleted.text || '').substring(0, 40)}...")
                                <a href="#" class="ms-2 fw-bold text-dark" onclick="event.preventDefault(); undoDeleteChunk('${toastId}');">Undo</a>
                            </div>
                            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
                        </div>
                    </div>`);
                const el = document.getElementById(toastId);
                const toast = new bootstrap.Toast(el, { delay: 8000 });
                toast.show();
                el.addEventListener('hidden.bs.toast', () => { el.remove(); });

                // Clear undo data after timeout
                _undoTimer = setTimeout(() => { _lastDeleted = null; }, 8000);

                await loadChunks(true);
            } catch (e) {
                showToast('Failed to delete line: ' + e.message, 'error');
            }
        };

        window.undoDeleteChunk = async (toastId) => {
            if (!_lastDeleted) {
                showToast('Nothing to undo', 'warning');
                return;
            }

            try {
                await API.post('/api/chunks/restore', {
                    chunk: _lastDeleted.chunk,
                    at_index: _lastDeleted.at_index
                });

                // Dismiss the toast
                const el = document.getElementById(toastId);
                if (el) {
                    const toast = bootstrap.Toast.getInstance(el);
                    if (toast) toast.hide();
                }

                _lastDeleted = null;
                clearTimeout(_undoTimer);
                showToast('Line restored', 'success');
                await loadChunks(true);
            } catch (e) {
                showToast('Undo failed: ' + e.message, 'error');
            }
        };

        window.stopOthers = (id) => {
            if (isPlayingSequence) return; // Sequence player handles its own logic
            document.querySelectorAll('audio').forEach(audio => {
                if (audio.dataset.id != id) {
                    audio.pause();
                }
            });
        };

        window.playSequence = async () => {
            isPlayingSequence = true;
            const btn = document.getElementById('btn-play-seq');
            btn.innerHTML = '<i class="fas fa-stop me-1"></i>Stop';
            btn.onclick = stopSequence;
            btn.classList.replace('btn-primary', 'btn-danger');

            const audios = Array.from(document.querySelectorAll('.chunk-audio'));
            if (audios.length === 0) {
                stopSequence();
                return;
            }

            let currentIndex = 0;

            const playNext = () => {
                if (!isPlayingSequence) return;

                // Find next valid audio
                while (currentIndex < audios.length) {
                    const audio = audios[currentIndex];
                    if (audio.getAttribute('src')) {
                        break;
                    }
                    currentIndex++;
                }

                if (currentIndex >= audios.length) {
                    stopSequence();
                    return;
                }

                const audio = audios[currentIndex];
                const tr = audio.closest('tr');

                // Visual feedback
                document.querySelectorAll('tr').forEach(r => r.classList.remove('table-primary'));
                tr.classList.add('table-primary');
                tr.scrollIntoView({ behavior: 'smooth', block: 'center' });

                const playPromise = audio.play();

                if (playPromise !== undefined) {
                    playPromise.catch(e => {
                        console.log("Play failed (empty or skipped):", e);
                        // If play fails, move next
                        currentIndex++;
                        playNext();
                    });
                }

                audio.onended = () => {
                    currentIndex++;
                    playNext();
                };

                audio.onerror = () => {
                     console.log("Audio error, skipping");
                     currentIndex++;
                     playNext();
                }
            };

            playNext();
        };

        window.stopSequence = () => {
            isPlayingSequence = false;
            document.querySelectorAll('audio').forEach(a => {
                a.pause();
                a.currentTime = 0;
                a.onended = null;
            });
            document.querySelectorAll('tr').forEach(r => r.classList.remove('table-primary'));

            const btn = document.getElementById('btn-play-seq');
            if (btn) {
                btn.innerHTML = '<i class="fas fa-play me-1"></i>Play Sequence';
                btn.onclick = playSequence;
                btn.classList.replace('btn-danger', 'btn-primary');
            }
        };

        window.updateChunk = async (id, field, value) => {
            try {
                const data = {};
                data[field] = value;
                await API.post(`/api/chunks/${id}`, data);
                // Don't reload entire table to preserve focus, but maybe update status badge if needed
                // For now, next loadChunks will show updated status (pending)
            } catch (e) {
                console.error("Update failed", e);
                showToast("Failed to update chunk", 'error');
            }
        };

        // Save all pending edits from a row before generation
        async function saveRowEdits(id) {
            const tr = document.querySelector(`tr[data-id="${id}"]`);
            if (!tr) return;

            const inputs = tr.querySelectorAll('input, textarea');
            const data = {};

            inputs.forEach(input => {
                const changeHandler = input.getAttribute('onchange');
                if (changeHandler) {
                    // Extract field name from onchange="updateChunk(id, 'field', this.value)"
                    const match = changeHandler.match(/updateChunk\(\d+,\s*'(\w+)'/);
                    if (match) {
                        data[match[1]] = input.value;
                    }
                }
            });

            // Save all fields at once
            if (Object.keys(data).length > 0) {
                console.log(`Saving chunk ${id} with data:`, data);
                await API.post(`/api/chunks/${id}`, data);
                console.log(`Chunk ${id} saved successfully`);
            }
        }

        window.generateChunk = async (id) => {
            try {
                // First, save any pending edits in this row
                await saveRowEdits(id);

                // Skip empty lines
                const tr = document.querySelector(`tr[data-id="${id}"]`);
                if (tr) {
                    const textArea = tr.querySelector('.chunk-text');
                    if (textArea && !textArea.value.trim()) {
                        showToast('Cannot generate audio for an empty line', 'error');
                        return;
                    }
                }

                // Optimistic UI update
                if (tr) {
                    const statusBadge = tr.querySelector('.badge');
                    statusBadge.className = 'badge bg-warning';
                    statusBadge.innerText = 'generating';

                    // Replace button with progress bar
                    const container = tr.querySelector('.d-flex');
                    const btn = container.querySelector('button');
                    if (btn) {
                         const progressBar = document.createElement('div');
                         progressBar.className = 'progress';
                         progressBar.style.width = '100px';
                         progressBar.style.height = '20px';
                         progressBar.innerHTML = '<div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" role="progressbar" style="width: 100%"></div>';
                         container.replaceChild(progressBar, btn);
                    }
                }

                await API.post(`/api/chunks/${id}/generate`, {});

                // Start polling with incremental updates (no full redraw)
                setTimeout(() => loadChunks(false), 1000);
            } catch (e) {
                showToast("Failed to start generation: " + e.message, 'error');
                loadChunks(true); // Revert UI with full redraw
            }
        };

        window.cancelRender = () => {
            isRenderingAll = false;
            document.getElementById('btn-render-all').style.display = 'inline-block';
            document.getElementById('btn-batch-fast').style.display = 'inline-block';
            document.getElementById('btn-regen-all').style.display = 'inline-block';
            document.getElementById('btn-cancel-render').style.display = 'none';
        };

        window.renderAll = async (regenerateAll = false) => {
            isRenderingAll = true;
            document.getElementById('btn-render-all').style.display = 'none';
            document.getElementById('btn-regen-all').style.display = 'none';
            document.getElementById('btn-cancel-render').style.display = 'inline-block';

            try {
                const chunks = await API.get('/api/chunks');
                const toProcess = (regenerateAll ? chunks : chunks.filter(c => c.status !== 'done'))
                    .filter(c => c.text && c.text.trim());

                if (toProcess.length === 0) {
                    showToast("No non-empty chunks to render!", 'warning');
                    cancelRender();
                    return;
                }

                if (regenerateAll && !await showConfirm(`Regenerate all ${toProcess.length} non-empty chunks? This will replace existing audio.`)) {
                    cancelRender();
                    return;
                }

                // Mark all chunks as generating in UI
                const indices = toProcess.map(c => c.id);
                for (const id of indices) {
                    const tr = document.querySelector(`tr[data-id="${id}"]`);
                    if (tr) {
                        tr.classList.add('table-info');
                        const badge = tr.querySelector('.badge');
                        if (badge) {
                            badge.className = 'badge bg-warning';
                            badge.innerText = 'generating';
                        }
                    }
                }

                // Call batch endpoint for parallel processing
                const response = await API.post('/api/generate_batch', { indices });
                console.log(`Batch generation started: ${response.total_chunks} chunks with ${response.workers} workers`);

                // Poll for completion
                const pollInterval = setInterval(async () => {
                    if (!isRenderingAll) {
                        clearInterval(pollInterval);
                        return;
                    }

                    try {
                        await loadChunks(false);
                        const updated = await API.get('/api/chunks');
                        const stillGenerating = updated.filter(c =>
                            indices.includes(c.id) && c.status === 'generating'
                        );

                        if (stillGenerating.length === 0) {
                            clearInterval(pollInterval);
                            // Clear highlights
                            document.querySelectorAll('tr').forEach(r => r.classList.remove('table-info'));
                            cancelRender();
                            await loadChunks(false);

                            // Show completion summary
                            const completed = updated.filter(c => indices.includes(c.id) && c.status === 'done').length;
                            const failed = updated.filter(c => indices.includes(c.id) && c.status === 'error').length;
                            if (failed > 0) {
                                showToast(`Batch complete: ${completed} succeeded, ${failed} failed`, 'warning');
                            }
                        }
                    } catch (e) {
                        console.error("Polling error", e);
                    }
                }, 2000);

            } catch (e) {
                console.error("Render All error:", e);
                showToast("Error during batch rendering: " + e.message, 'error');
                cancelRender();
            }
        };

        window.renderBatchFast = async (regenerateAll = false) => {
            isRenderingAll = true;
            document.getElementById('btn-render-all').style.display = 'none';
            document.getElementById('btn-batch-fast').style.display = 'none';
            document.getElementById('btn-regen-all').style.display = 'none';
            document.getElementById('btn-cancel-render').style.display = 'inline-block';

            try {
                const chunks = await API.get('/api/chunks');
                const toProcess = (regenerateAll ? chunks : chunks.filter(c => c.status !== 'done'))
                    .filter(c => c.text && c.text.trim());

                if (toProcess.length === 0) {
                    showToast("No non-empty chunks to render!", 'warning');
                    cancelRender();
                    return;
                }

                // Mark all chunks as generating in UI
                const indices = toProcess.map(c => c.id);
                for (const id of indices) {
                    const tr = document.querySelector(`tr[data-id="${id}"]`);
                    if (tr) {
                        tr.classList.add('table-info');
                        const badge = tr.querySelector('.badge');
                        if (badge) {
                            badge.className = 'badge bg-warning';
                            badge.innerText = 'generating';
                        }
                    }
                }

                // Call fast batch endpoint (requires custom Qwen3-TTS)
                const response = await API.post('/api/generate_batch_fast', { indices });
                console.log(`Fast batch started: ${response.total_chunks} chunks (batch_size=${response.batch_size}, seed=${response.batch_seed})`);

                // Poll for completion
                const pollInterval = setInterval(async () => {
                    if (!isRenderingAll) {
                        clearInterval(pollInterval);
                        return;
                    }

                    try {
                        await loadChunks(false);
                        const updated = await API.get('/api/chunks');
                        const stillGenerating = updated.filter(c =>
                            indices.includes(c.id) && c.status === 'generating'
                        );

                        if (stillGenerating.length === 0) {
                            clearInterval(pollInterval);
                            document.querySelectorAll('tr').forEach(r => r.classList.remove('table-info'));
                            cancelRender();
                            await loadChunks(false);

                            const completed = updated.filter(c => indices.includes(c.id) && c.status === 'done').length;
                            const failed = updated.filter(c => indices.includes(c.id) && c.status === 'error').length;
                            if (failed > 0) {
                                showToast(`Batch complete: ${completed} succeeded, ${failed} failed`, 'warning');
                            }
                        }
                    } catch (e) {
                        console.error("Polling error", e);
                    }
                }, 2000);

            } catch (e) {
                console.error("Batch Fast error:", e);
                showToast("Error during batch rendering: " + e.message, 'error');
                cancelRender();
            }
        };

        document.getElementById('btn-merge').addEventListener('click', async () => {
             if (!await showConfirm("Merge all valid audio chunks into final audiobook?")) return;

             try {
                 await API.post('/api/merge', {});
                 // Switch to Result tab and poll
                 document.querySelector('[data-tab="audio"]').click();
                 pollLogs('audio', 'audio-logs');
             } catch (e) {
                 showToast("Merge failed: " + e.message, 'error');
             }
        });


        // --- Audacity Export ---
        window.exportAudacity = async () => {
            const statusEl = document.getElementById('audacity-status');
            statusEl.innerHTML = '<span class="text-info"><i class="fas fa-spinner fa-spin me-1"></i>Exporting...</span>';

            try {
                await API.post('/api/export_audacity', {});

                const poll = setInterval(async () => {
                    try {
                        const status = await API.get('/api/status/audacity_export');
                        if (!status.running) {
                            clearInterval(poll);
                            if (status.logs.some(l => l.includes("complete"))) {
                                statusEl.innerHTML = '<span class="text-success"><i class="fas fa-check me-1"></i>Done!</span>';
                                // Auto-download the zip
                                const a = document.createElement('a');
                                a.href = `/api/export_audacity?t=${Date.now()}`;
                                a.download = 'audacity_export.zip';
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                                setTimeout(() => { statusEl.innerHTML = ''; }, 5000);
                            } else {
                                const lastLog = status.logs[status.logs.length - 1] || 'Unknown error';
                                statusEl.innerHTML = `<span class="text-danger"><i class="fas fa-times me-1"></i>${lastLog}</span>`;
                            }
                        }
                    } catch (e) {
                        clearInterval(poll);
                        statusEl.innerHTML = `<span class="text-danger">Poll error: ${e.message}</span>`;
                    }
                }, 1000);
            } catch (e) {
                statusEl.innerHTML = `<span class="text-danger"><i class="fas fa-times me-1"></i>${e.message}</span>`;
            }
        };

        // --- Polling Logic ---
        async function pollLogs(taskName, elementId) {
            const el = document.getElementById(elementId);
            const interval = setInterval(async () => {
                try {
                    const status = await API.get(`/api/status/${taskName}`);
                    el.innerText = status.logs.join('\n');
                    el.scrollTop = el.scrollHeight;

                    if (!status.running) {
                        clearInterval(interval);
                        if (taskName === 'audio' && status.logs.some(l => l.includes("complete"))) {
                            // Load audio player
                            const audio = document.getElementById('main-audio');
                            audio.src = `/api/audiobook?t=${new Date().getTime()}`;
                            document.getElementById('audio-player-container').style.display = 'block';
                            document.getElementById('download-link').href = audio.src;
                        }
                        // Refresh editor chunks when script generation or review completes
                        if ((taskName === 'script' || taskName === 'review') && status.logs.some(l => l.includes("completed successfully"))) {
                            // Clear cached chunks table so next load shows fresh data
                            const tbody = document.getElementById('chunks-table-body');
                            if (tbody) tbody.innerHTML = '';
                            // If editor tab is visible, refresh immediately
                            if (document.getElementById('editor-tab').style.display !== 'none') {
                                loadChunks();
                            }
                        }
                    }
                } catch (e) {
                    console.error("Poll error", e);
                    clearInterval(interval);
                }
            }, 1000);
        }

        //  Saved Scripts 

        async function loadSavedScripts() {
            try {
                const res = await fetch('/api/scripts');
                const scripts = await res.json();
                const container = document.getElementById('saved-scripts-list');

                if (!scripts.length) {
                    container.innerHTML = '<p class="text-muted mb-0">No saved scripts yet.</p>';
                    return;
                }

                container.innerHTML = scripts.map(s => {
                    const date = new Date(s.created * 1000).toLocaleDateString('en-US', {
                        month: 'short', day: 'numeric', year: 'numeric'
                    });
                    const voiceBadge = s.has_voice_config
                        ? '<span class="badge bg-info ms-2" title="Includes voice configuration">voices</span>'
                        : '';
                    return `
                        <div class="d-flex align-items-center justify-content-between py-2 border-bottom">
                            <div>
                                <strong>${s.name}</strong>${voiceBadge}
                                <small class="text-muted ms-2">${date}</small>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-success me-1" onclick="loadScript('${s.name}')"><i class="fas fa-upload me-1"></i>Load</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteScript('${s.name}')"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>`;
                }).join('');
            } catch (e) {
                console.error('Failed to load saved scripts:', e);
            }
        }

        async function saveScript() {
            const nameInput = document.getElementById('save-script-name');
            const name = nameInput.value.trim();
            if (!name) {
                showToast('Please enter a name for the script.', 'warning');
                return;
            }
            try {
                const res = await fetch('/api/scripts/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name})
                });
                if (!res.ok) {
                    const err = await res.json();
                    showToast(err.detail || 'Failed to save script.', 'error');
                    return;
                }
                nameInput.value = '';
                loadSavedScripts();
            } catch (e) {
                showToast('Error saving script: ' + e.message, 'error');
            }
        }

        async function loadScript(name) {
            if (!await showConfirm(`Load "${name}"? This will replace your current script and chunks.`)) return;
            try {
                const res = await fetch('/api/scripts/load', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name})
                });
                if (!res.ok) {
                    const err = await res.json();
                    showToast(err.detail || 'Failed to load script.', 'error');
                    return;
                }
                loadSavedScripts();
                loadChunks();
                loadVoices();
            } catch (e) {
                showToast('Error loading script: ' + e.message, 'error');
            }
        }

        async function deleteScript(name) {
            if (!await showConfirm(`Delete saved script "${name}"? This cannot be undone.`)) return;
            try {
                const res = await fetch(`/api/scripts/${encodeURIComponent(name)}`, {method: 'DELETE'});
                if (!res.ok) {
                    const err = await res.json();
                    showToast(err.detail || 'Failed to delete script.', 'error');
                    return;
                }
                loadSavedScripts();
            } catch (e) {
                showToast('Error deleting script: ' + e.message, 'error');
            }
        }

        // --- Voice Designer ---
        window._designedVoicesCache = [];
        window._currentPreviewFile = null;

        async function loadDesignedVoices() {
            try {
                const voices = await API.get('/api/voice_design/list');
                window._designedVoicesCache = voices;
                const container = document.getElementById('designed-voices-list');

                if (!voices.length) {
                    container.innerHTML = '<p class="text-muted mb-0">No designed voices yet. Generate and save a preview above.</p>';
                    return;
                }

                container.innerHTML = `
                    <table class="table table-sm table-hover mb-0">
                        <thead><tr><th>Name</th><th>Description</th><th style="width:120px">Actions</th></tr></thead>
                        <tbody>
                            ${voices.map(v => `
                                <tr>
                                    <td><strong>${v.name}</strong></td>
                                    <td class="text-muted" style="max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${v.description}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary me-1" onclick="playDesignedVoice('${v.filename}')" title="Play"><i class="fas fa-play"></i></button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteDesignedVoice('${v.id}')" title="Delete"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>`;
            } catch (e) {
                console.error('Failed to load designed voices:', e);
            }
        }

        window.generateDesignPreview = async () => {
            const description = document.getElementById('design-description').value.trim();
            const sampleText = document.getElementById('design-sample-text').value.trim();
            const statusEl = document.getElementById('design-status');
            const previewContainer = document.getElementById('design-preview-container');

            if (!description) { showToast('Please enter a voice description.', 'warning'); return; }
            if (!sampleText) { showToast('Please enter sample text.', 'warning'); return; }

            const btn = document.getElementById('btn-design-preview');
            btn.disabled = true;
            statusEl.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generating preview (this may take a moment on first run)...';
            previewContainer.style.display = 'none';

            try {
                const result = await API.post('/api/voice_design/preview', {
                    description: description,
                    sample_text: sampleText
                });

                const audio = document.getElementById('design-preview-audio');
                audio.src = result.audio_url + '?t=' + Date.now();
                previewContainer.style.display = 'block';
                statusEl.innerHTML = '<span class="text-success"><i class="fas fa-check me-1"></i>Preview ready</span>';

                // Extract filename from URL for save
                window._currentPreviewFile = result.audio_url.split('/').pop().split('?')[0];
            } catch (e) {
                statusEl.innerHTML = `<span class="text-danger"><i class="fas fa-times me-1"></i>Failed: ${e.message}</span>`;
            } finally {
                btn.disabled = false;
            }
        };

        window.saveDesignedVoice = async () => {
            const name = document.getElementById('design-voice-name').value.trim();
            if (!name) { showToast('Please enter a name for the voice.', 'warning'); return; }
            if (!window._currentPreviewFile) { showToast('Generate a preview first.', 'warning'); return; }

            try {
                await API.post('/api/voice_design/save', {
                    name: name,
                    description: document.getElementById('design-description').value.trim(),
                    sample_text: document.getElementById('design-sample-text').value.trim(),
                    preview_file: window._currentPreviewFile
                });
                document.getElementById('design-voice-name').value = '';
                loadDesignedVoices();
            } catch (e) {
                showToast('Error saving voice: ' + e.message, 'error');
            }
        };

        window.playDesignedVoice = (filename) => {
            const audio = new Audio(`/designed_voices/${filename}?t=${Date.now()}`);
            audio.play();
        };

        window.deleteDesignedVoice = async (voiceId) => {
            if (!await showConfirm('Delete this designed voice?')) return;
            try {
                const res = await fetch(`/api/voice_design/${encodeURIComponent(voiceId)}`, {method: 'DELETE'});
                if (!res.ok) { const err = await res.json(); showToast(err.detail || 'Failed to delete.', 'error'); return; }
                loadDesignedVoices();
            } catch (e) {
                showToast('Error deleting voice: ' + e.message, 'error');
            }
        };

        window.onDesignedVoiceSelect = (select) => {
            const card = select.closest('.card-body');
            const refText = card.querySelector('.ref-text');
            const refAudio = card.querySelector('.ref-audio');
            const val = select.value;

            if (val === '' || val === '__manual__') {
                refAudio.readOnly = false;
                if (val === '__manual__') {
                    refAudio.value = '';
                    refText.value = '';
                }
                refAudio.focus();
                return;
            }

            // Find the designed voice
            const voice = window._designedVoicesCache.find(v => v.id === val);
            if (voice) {
                // Use absolute path relative to project root
                refAudio.value = `designed_voices/${voice.filename}`;
                refText.value = voice.sample_text;
                refAudio.readOnly = true;
            }
        };

        // --- LoRA Training ---
        window._loraModelsCache = [];

        async function loadLoraDatasets() {
            try {
                const datasets = await API.get('/api/lora/datasets');
                const listEl = document.getElementById('lora-datasets-list');
                const selectEl = document.getElementById('lora-dataset-select');

                // Update dropdown
                const currentVal = selectEl.value;
                selectEl.innerHTML = '<option value="">-- Select dataset --</option>' +
                    datasets.map(d => `<option value="${d.dataset_id}">${d.dataset_id} (${d.sample_count} samples)</option>`).join('');
                if (currentVal) selectEl.value = currentVal;

                // Update list
                if (!datasets.length) {
                    listEl.innerHTML = '<span class="text-muted">No datasets uploaded yet.</span>';
                    return;
                }
                listEl.innerHTML = datasets.map(d => `
                    <div class="d-flex justify-content-between align-items-center py-1">
                        <span><strong>${d.dataset_id}</strong> <small class="text-muted">(${d.sample_count} samples)</small></span>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteLoraDataset('${d.dataset_id}')"><i class="fas fa-trash"></i></button>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load LoRA datasets:', e);
            }
        }

        window.uploadLoraDataset = async () => {
            const fileInput = document.getElementById('lora-dataset-file');
            if (!fileInput.files.length) { showToast('Select a ZIP file first.', 'warning'); return; }

            const file = fileInput.files[0];
            if (!file.name.endsWith('.zip')) { showToast('File must be a .zip archive.', 'warning'); return; }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch('/api/lora/upload_dataset', { method: 'POST', body: formData });
                if (!res.ok) {
                    const err = await res.json();
                    showToast(err.detail || 'Upload failed.', 'error');
                    return;
                }
                const result = await res.json();
                showToast(`Dataset "${result.dataset_id}" uploaded (${result.sample_count} samples).`, 'success');
                fileInput.value = '';
                loadLoraDatasets();
            } catch (e) {
                showToast('Upload error: ' + e.message, 'error');
            }
        };

        window.deleteLoraDataset = async (datasetId) => {
            if (!await showConfirm(`Delete dataset "${datasetId}"?`)) return;
            try {
                const res = await fetch(`/api/lora/datasets/${encodeURIComponent(datasetId)}`, { method: 'DELETE' });
                if (!res.ok) { const err = await res.json(); showToast(err.detail || 'Failed to delete.', 'error'); return; }
                loadLoraDatasets();
            } catch (e) {
                showToast('Error deleting dataset: ' + e.message, 'error');
            }
        };


        window.startLoraTraining = async () => {
            const name = document.getElementById('lora-adapter-name').value.trim();
            const datasetId = document.getElementById('lora-dataset-select').value;
            if (!name) { showToast('Enter an adapter name.', 'warning'); return; }
            if (!datasetId) { showToast('Select a dataset.', 'warning'); return; }

            const request = {
                name: name,
                dataset_id: datasetId,
                epochs: parseInt(document.getElementById('lora-epochs').value) || 5,
                lr: parseFloat(document.getElementById('lora-lr').value) || 5e-6,
                batch_size: parseInt(document.getElementById('lora-batch-size').value) || 1,
                lora_r: parseInt(document.getElementById('lora-rank').value) || 32,
                lora_alpha: parseInt(document.getElementById('lora-alpha').value) || 128,
                gradient_accumulation_steps: parseInt(document.getElementById('lora-grad-accum').value) || 8
            };

            const btn = document.getElementById('btn-lora-train');
            btn.disabled = true;
            document.getElementById('lora-train-status').innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Starting...';

            try {
                const result = await API.post('/api/lora/train', request);
                document.getElementById('lora-progress-section').style.display = 'block';
                document.getElementById('lora-train-status').innerHTML = '<span class="text-info">Training in progress...</span>';
                pollLoraTraining(request.epochs);
            } catch (e) {
                showToast('Failed to start training: ' + e.message, 'error');
                btn.disabled = false;
                document.getElementById('lora-train-status').innerHTML = '';
            }
        };

        function pollLoraTraining(totalEpochs) {
            const logsEl = document.getElementById('lora-train-logs');
            const progressBar = document.getElementById('lora-progress-bar');
            const epochDisplay = document.getElementById('lora-epoch-display');
            const lossDisplay = document.getElementById('lora-loss-display');

            const interval = setInterval(async () => {
                try {
                    const status = await API.get('/api/status/lora_training');
                    logsEl.innerText = status.logs.join('\n');
                    logsEl.scrollTop = logsEl.scrollHeight;

                    // Parse latest metrics from log lines
                    for (let i = status.logs.length - 1; i >= 0; i--) {
                        const line = status.logs[i];
                        const epochMatch = line.match(/\[EPOCH\]\s*(\d+)\/(\d+)\s+avg_loss=([\d.]+)/);
                        if (epochMatch) {
                            const epoch = parseInt(epochMatch[1]);
                            const maxEpoch = parseInt(epochMatch[2]);
                            const loss = epochMatch[3];
                            const pct = Math.round((epoch / maxEpoch) * 100);
                            epochDisplay.innerText = `${epoch}/${maxEpoch}`;
                            lossDisplay.innerText = loss;
                            progressBar.style.width = `${pct}%`;
                            progressBar.innerText = `${pct}%`;
                            break;
                        }
                        const trainMatch = line.match(/\[TRAIN\]\s*epoch=(\d+)\/(\d+)\s+step=\d+\/\d+\s+loss=([\d.]+)/);
                        if (trainMatch) {
                            const epoch = parseInt(trainMatch[1]);
                            const maxEpoch = parseInt(trainMatch[2]);
                            const loss = trainMatch[3];
                            const pct = Math.round(((epoch - 1) / maxEpoch) * 100);
                            epochDisplay.innerText = `${epoch}/${maxEpoch}`;
                            lossDisplay.innerText = loss;
                            progressBar.style.width = `${pct}%`;
                            progressBar.innerText = `${pct}%`;
                            break;
                        }
                    }

                    if (!status.running) {
                        clearInterval(interval);
                        const btn = document.getElementById('btn-lora-train');
                        btn.disabled = false;

                        const isDone = status.logs.some(l => l.includes('[DONE]'));
                        const isError = status.logs.some(l => l.includes('[ERROR]'));

                        if (isDone) {
                            document.getElementById('lora-train-status').innerHTML = '<span class="text-success"><i class="fas fa-check me-1"></i>Training complete!</span>';
                            progressBar.style.width = '100%';
                            progressBar.innerText = '100%';
                            progressBar.classList.remove('progress-bar-animated');
                            progressBar.classList.replace('bg-info', 'bg-success');
                            loadLoraModels();
                        } else if (isError) {
                            document.getElementById('lora-train-status').innerHTML = '<span class="text-danger"><i class="fas fa-times me-1"></i>Training failed</span>';
                            progressBar.classList.remove('progress-bar-animated');
                            progressBar.classList.replace('bg-info', 'bg-danger');
                        } else {
                            document.getElementById('lora-train-status').innerHTML = '<span class="text-warning">Training stopped</span>';
                        }
                    }
                } catch (e) {
                    console.error('LoRA poll error:', e);
                    clearInterval(interval);
                }
            }, 2000);
        }

        async function loadLoraModels() {
            try {
                const models = await API.get('/api/lora/models');
                window._loraModelsCache = models;
                const container = document.getElementById('lora-models-list');
                const testForm = document.getElementById('lora-test-form');

                if (!models.length) {
                    container.innerHTML = '<p class="text-muted mb-0">No adapters available.</p>';
                    testForm.style.display = 'none';
                    return;
                }

                container.innerHTML = `
                    <table class="table table-sm table-hover mb-0">
                        <thead><tr><th>Name</th><th>Dataset</th><th>Epochs</th><th>Final Loss</th><th>Samples</th><th style="width:240px">Actions</th></tr></thead>
                        <tbody>
                            ${models.map(m => `
                                <tr${m.builtin ? ' class="table-light"' : ''}>
                                    <td><strong>${m.name}</strong>${m.builtin ? ' <span class="badge bg-secondary">built-in</span>' : ''}</td>
                                    <td>${m.dataset_id || (m.builtin ? '--' : '--')}</td>
                                    <td>${m.epochs || '--'}</td>
                                    <td>${m.final_loss != null ? m.final_loss.toFixed(4) : '--'}</td>
                                    <td>${m.sample_count || '--'}</td>
                                    <td>
                                        <button class="btn btn-sm ${m.preview_audio_url ? 'btn-outline-success' : 'btn-outline-secondary'} me-1" id="lora-preview-btn-${m.id}" onclick="playLoraPreview('${m.id}')" title="${m.preview_audio_url ? 'Play preview' : 'Generate and play preview (first time may take a moment)'}"><i class="fas fa-volume-up"></i></button>
                                        <button class="btn btn-sm btn-outline-primary me-1" onclick="testLoraModel('${m.id}')" title="Generate test line with custom text"><i class="fas fa-flask me-1"></i>Test</button>
                                        ${m.builtin ? '' : `<button class="btn btn-sm btn-outline-danger" onclick="deleteLoraModel('${m.id}')" title="Delete"><i class="fas fa-trash"></i></button>`}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>`;

                // Populate test dropdown
                const dropdown = document.getElementById('lora-test-adapter');
                const prevVal = dropdown.value;
                dropdown.innerHTML = models.map(m =>
                    `<option value="${m.id}">${m.name}</option>`
                ).join('');
                if (prevVal && models.some(m => m.id === prevVal)) dropdown.value = prevVal;
                testForm.style.display = '';
            } catch (e) {
                console.error('Failed to load LoRA models:', e);
            }
        }

        window.playLoraPreview = async (adapterId) => {
            const btn = document.getElementById(`lora-preview-btn-${adapterId}`);
            const origHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const result = await API.post(`/api/lora/preview/${encodeURIComponent(adapterId)}`, {});
                const audio = new Audio(`${result.audio_url}?t=${Date.now()}`);
                audio.play();
                // Update button now that preview is cached
                btn.title = 'Play preview';
                btn.classList.replace('btn-outline-secondary', 'btn-outline-success');
            } catch (e) {
                showToast('Preview failed: ' + e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = origHtml;
            }
        };

        window.testLoraModel = (adapterId) => {
            document.getElementById('lora-test-adapter').value = adapterId;
            document.getElementById('lora-test-form').style.display = '';
            document.getElementById('lora-test-text').focus();
        };

        window.runLoraTest = async () => {
            const adapterId = document.getElementById('lora-test-adapter').value;
            const text = document.getElementById('lora-test-text').value.trim();
            const instruct = document.getElementById('lora-test-instruct').value.trim();
            if (!adapterId) { showToast('Select an adapter.', 'warning'); return; }
            if (!text) { showToast('Enter text to synthesize.', 'warning'); return; }

            const statusEl = document.getElementById('lora-test-status');
            statusEl.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generating...';

            try {
                const result = await API.post('/api/lora/test', {
                    adapter_id: adapterId,
                    text: text,
                    instruct: instruct
                });

                statusEl.innerHTML = '';
                const audioDiv = document.getElementById('lora-test-audio');
                audioDiv.innerHTML = `<audio controls autoplay src="${result.audio_url}?t=${Date.now()}"></audio>`;
            } catch (e) {
                statusEl.innerHTML = `<span class="text-danger">Failed: ${e.message}</span>`;
            }
        };

        window.deleteLoraModel = async (adapterId) => {
            if (!await showConfirm('Delete this trained adapter? This cannot be undone.')) return;
            try {
                const res = await fetch(`/api/lora/models/${encodeURIComponent(adapterId)}`, { method: 'DELETE' });
                if (!res.ok) { const err = await res.json(); showToast(err.detail || 'Failed to delete.', 'error'); return; }
                loadLoraModels();
            } catch (e) {
                showToast('Error deleting adapter: ' + e.message, 'error');
            }
        };

        //  Dataset Builder 

        // In-memory row data: [{emotion, text, status, audio_url}, ...]
        let dsbRows = [];
        let dsbPolling = null;
        let dsbBatchRunning = false;
        let dsbSaveMetaTimer = null;
        let dsbSaveRowsTimer = null;
        let dsbCurrentProject = '';

        // Clean up legacy localStorage
        localStorage.removeItem('alexandria-dsb-form');

        async function dsbLoadProjects(selectName) {
            try {
                const projects = await API.get('/api/dataset_builder/list');
                const select = document.getElementById('dsb-project-select');
                select.innerHTML = '<option value="">-- Select project --</option>' +
                    projects.map(p => `<option value="${p.name}">${p.name} (${p.done_count}/${p.sample_count})</option>`).join('');
                if (selectName) {
                    select.value = selectName;
                    dsbOnProjectChange();
                }
            } catch (e) { console.error('Failed to load projects:', e); }
        }

        window.dsbOnProjectChange = async () => {
            const name = document.getElementById('dsb-project-select').value;
            const formArea = document.getElementById('dsb-form-area');
            const deleteBtn = document.getElementById('dsb-btn-delete-project');
            if (!name) {
                dsbCurrentProject = '';
                formArea.style.display = 'none';
                deleteBtn.style.display = 'none';
                dsbRows = [];
                dsbRenderTable();
                return;
            }
            dsbCurrentProject = name;
            formArea.style.display = '';
            deleteBtn.style.display = '';
            await dsbLoadProject(name);
        };

        async function dsbLoadProject(name) {
            try {
                const result = await API.get(`/api/dataset_builder/status/${encodeURIComponent(name)}`);
                document.getElementById('dsb-description').value = result.description || '';
                document.getElementById('dsb-global-seed').value = result.global_seed || '';
                dsbRows = (result.samples || []).map(s => ({
                    emotion: s.emotion || s.description || '',
                    text: s.text || '',
                    seed: s.seed ?? '',
                    status: s.status || 'pending',
                    audio_url: s.audio_url || null,
                }));
                if (dsbRows.length === 0) dsbAddRow();
                dsbRenderTable();
                // Resume polling if batch is running
                if (result.running) {
                    dsbBatchRunning = true;
                    dsbStartPolling(name);
                    document.getElementById('dsb-btn-gen-all').style.display = 'none';
                    document.getElementById('dsb-btn-regen-all').style.display = 'none';
                    document.getElementById('dsb-btn-cancel').style.display = '';
                }
            } catch (e) {
                dsbRows = [];
                dsbAddRow();
            }
        }

        window.dsbCreateProject = async () => {
            const name = prompt('Dataset name:');
            if (!name || !name.trim()) return;
            try {
                const result = await API.post('/api/dataset_builder/create', { name: name.trim() });
                await dsbLoadProjects(result.name);
            } catch (e) {
                showToast('Failed to create project: ' + e.message, 'error');
            }
        };

        window.dsbDeleteProject = async () => {
            if (!dsbCurrentProject) return;
            if (!await showConfirm(`Delete project "${dsbCurrentProject}" and all its samples?`)) return;
            try {
                await fetch(`/api/dataset_builder/${encodeURIComponent(dsbCurrentProject)}`, { method: 'DELETE' });
                dsbCurrentProject = '';
                document.getElementById('dsb-form-area').style.display = 'none';
                document.getElementById('dsb-btn-delete-project').style.display = 'none';
                dsbRows = [];
                dsbRenderTable();
                await dsbLoadProjects();
            } catch (e) {
                showToast('Delete failed: ' + e.message, 'error');
            }
        };

        function dsbSaveForm() {
            if (!dsbCurrentProject) return;
            clearTimeout(dsbSaveMetaTimer);
            dsbSaveMetaTimer = setTimeout(async () => {
                try {
                    await API.post('/api/dataset_builder/update_meta', {
                        name: dsbCurrentProject,
                        description: document.getElementById('dsb-description').value,
                        global_seed: document.getElementById('dsb-global-seed').value,
                    });
                } catch (e) { console.error('Failed to save meta:', e); }
            }, 500);
        }

        function dsbSaveRows() {
            if (!dsbCurrentProject) return;
            clearTimeout(dsbSaveRowsTimer);
            dsbSaveRowsTimer = setTimeout(async () => {
                try {
                    await API.post('/api/dataset_builder/update_rows', {
                        name: dsbCurrentProject,
                        rows: dsbRows.map(r => ({ emotion: r.emotion || '', text: (r.text || '').trim(), seed: r.seed ?? '' })),
                    });
                } catch (e) { console.error('Failed to save rows:', e); }
            }, 500);
        }

        function dsbAddRow(emotion = '', text = '', seed = '') {
            dsbRows.push({ emotion, text, seed, status: 'pending', audio_url: null });
            dsbRenderTable();
            dsbSaveRows();
            // Focus the new emotion field
            setTimeout(() => {
                const rows = document.querySelectorAll('#dsb-table-body tr');
                const last = rows[rows.length - 1];
                if (last) last.querySelector('input')?.focus();
            }, 50);
        }

        function dsbRemoveRow(index) {
            dsbRows.splice(index, 1);
            dsbRenderTable();
            dsbSaveRows();
            dsbUpdateRefDropdown();
        }

        function dsbBuildRowHtml(row, i) {
            const statusColor = row.status === 'done' ? 'success' :
                                row.status === 'generating' ? 'warning' :
                                row.status === 'error' ? 'danger' : 'secondary';
            const statusLabel = row.status || 'pending';

            let actionHtml = '';
            if (row.status === 'generating') {
                actionHtml = '<div class="progress" style="width:80px;height:20px;"><div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" style="width:100%"></div></div>';
            } else {
                const genLabel = row.status === 'done' ? '<i class="fas fa-redo"></i>' : '<i class="fas fa-play"></i>';
                actionHtml = `<button class="btn btn-sm btn-primary" onclick="dsbGenSample(${i})" title="${row.status === 'done' ? 'Regenerate' : 'Generate'}">${genLabel}</button>`;
            }

            let audioHtml = '';
            if (row.status === 'done' && row.audio_url) {
                audioHtml = `<audio controls src="${row.audio_url}" style="width:180px;height:28px;" onplay="dsbStopOthers(${i})"></audio>`;
            }

            return `<tr data-dsb-idx="${i}" data-dsb-status="${row.status || 'pending'}" data-dsb-audio="${row.audio_url || ''}" class="${row.status === 'generating' ? 'table-info' : ''}">
                <td class="text-center align-middle">${i + 1}</td>
                <td><input type="text" class="form-control form-control-sm" value="${(row.emotion || '').replace(/"/g, '&quot;')}" onchange="dsbUpdateRow(${i}, 'emotion', this.value)" placeholder="e.g. Savagely sarcastic"></td>
                <td><textarea class="form-control form-control-sm" rows="2" onchange="dsbUpdateRow(${i}, 'text', this.value)" placeholder="Sample text...">${(row.text || '').replace(/</g, '&lt;')}</textarea></td>
                <td><input type="number" class="form-control form-control-sm" value="${row.seed ?? ''}" onchange="dsbUpdateRow(${i}, 'seed', this.value)" placeholder="-" style="width:65px;" min="-1"></td>
                <td class="text-center align-middle"><span class="badge bg-${statusColor}">${statusLabel}</span></td>
                <td class="align-middle">
                    <div class="d-flex align-items-center gap-1">
                        ${actionHtml}
                        ${audioHtml}
                        <button class="btn btn-sm btn-outline-danger ms-auto" onclick="dsbRemoveRow(${i})" title="Delete row"><i class="fas fa-trash"></i></button>
                    </div>
                </td>
            </tr>`;
        }

        function dsbRenderTable(changedIndices) {
            const tbody = document.getElementById('dsb-table-body');

            // Full rebuild if no specific indices or row count changed
            if (!changedIndices || tbody.children.length !== dsbRows.length) {
                tbody.innerHTML = dsbRows.map((row, i) => dsbBuildRowHtml(row, i)).join('');
                dsbUpdateProgress();
                return;
            }

            // Targeted update: only re-render changed rows
            for (const i of changedIndices) {
                const existing = tbody.children[i];
                if (!existing) continue;
                const row = dsbRows[i];
                const oldStatus = existing.getAttribute('data-dsb-status');
                const oldAudio = existing.getAttribute('data-dsb-audio');
                if (oldStatus === (row.status || 'pending') && oldAudio === (row.audio_url || '')) continue;
                const temp = document.createElement('tbody');
                temp.innerHTML = dsbBuildRowHtml(row, i);
                existing.replaceWith(temp.firstElementChild);
            }
            dsbUpdateProgress();
        }

        window.dsbUpdateRow = (index, field, value) => {
            if (dsbRows[index]) {
                dsbRows[index][field] = value;
                dsbSaveRows();
            }
        };

        window.dsbStopOthers = (index) => {
            document.querySelectorAll('#dsb-table-body audio').forEach(audio => {
                const row = audio.closest('tr');
                if (row && parseInt(row.getAttribute('data-dsb-idx')) !== index) audio.pause();
            });
        };

        let dsbLastDoneCount = -1;

        function dsbUpdateProgress() {
            const done = dsbRows.filter(r => r.status === 'done').length;
            const total = dsbRows.length;
            const pct = total > 0 ? Math.round((done / total) * 100) : 0;
            const wrap = document.getElementById('dsb-progress-wrap');
            const bar = document.getElementById('dsb-progress-bar');
            if (done > 0 || dsbBatchRunning) {
                wrap.style.display = '';
                bar.style.width = pct + '%';
                bar.innerText = `${pct}% (${done}/${total})`;
            } else {
                wrap.style.display = 'none';
            }
            // Only rebuild dropdown when done count actually changes
            if (done !== dsbLastDoneCount) {
                dsbLastDoneCount = done;
                dsbUpdateRefDropdown();
            }
        }

        function dsbUpdateRefDropdown() {
            const select = document.getElementById('dsb-ref-select');
            const doneSamples = dsbRows.map((r, i) => ({ index: i, row: r })).filter(x => x.row.status === 'done');
            select.innerHTML = doneSamples.length === 0
                ? '<option value="0">No completed samples yet</option>'
                : doneSamples.map(x => `<option value="${x.index}">${x.index + 1}. ${(x.row.emotion || 'neutral').substring(0, 30)} - "${(x.row.text || '').substring(0, 40)}..."</option>`).join('');
        }

        // Single sample generation
        window.dsbGenSample = async (index) => {
            const name = dsbCurrentProject;
            const rootDesc = document.getElementById('dsb-description').value.trim();
            if (!name) { showToast('Select or create a project first.', 'warning'); return; }
            if (!rootDesc) { showToast('Enter a root voice description first.', 'warning'); return; }

            const row = dsbRows[index];
            if (!row || !row.text.trim()) { showToast('This row has no text.', 'warning'); return; }

            const emotion = row.emotion.trim();
            const description = emotion ? `${rootDesc}, ${emotion}` : rootDesc;

            // Resolve seed: per-line > global > random
            const globalSeed = parseInt(document.getElementById('dsb-global-seed').value);
            const lineSeed = row.seed !== '' ? parseInt(row.seed) : NaN;
            const seed = !isNaN(lineSeed) && lineSeed >= 0 ? lineSeed : (!isNaN(globalSeed) && globalSeed >= 0 ? globalSeed : -1);

            // Optimistic UI
            dsbRows[index].status = 'generating';
            dsbRenderTable([index]);

            try {
                const result = await API.post('/api/dataset_builder/generate_sample', {
                    description,
                    text: row.text.trim(),
                    dataset_name: name,
                    sample_index: index,
                    seed,
                });
                dsbRows[index].status = 'done';
                dsbRows[index].audio_url = result.audio_url;
            } catch (e) {
                dsbRows[index].status = 'error';
                console.error('Sample generation failed:', e);
            }
            dsbRenderTable([index]);
        };

        // Batch generation
        window.dsbGenerateAll = async (regenAll = false) => {
            const name = dsbCurrentProject;
            const rootDesc = document.getElementById('dsb-description').value.trim();
            if (!name) { showToast('Select or create a project first.', 'warning'); return; }
            if (!rootDesc) { showToast('Enter a root voice description first.', 'warning'); return; }

            const samples = dsbRows.filter(r => r.text.trim());
            if (samples.length === 0) { showToast('Add at least one sample with text.', 'warning'); return; }

            const indices = regenAll
                ? dsbRows.map((_, i) => i).filter(i => dsbRows[i].text.trim())
                : dsbRows.map((r, i) => i).filter(i => dsbRows[i].text.trim() && dsbRows[i].status !== 'done');

            if (indices.length === 0) { showToast('All samples are already generated.', 'warning'); return; }
            if (regenAll && !await showConfirm(`Regenerate all ${indices.length} samples?`)) return;

            // Mark as generating
            indices.forEach(i => { dsbRows[i].status = 'generating'; });
            dsbRenderTable();
            dsbBatchRunning = true;
            document.getElementById('dsb-btn-gen-all').style.display = 'none';
            document.getElementById('dsb-btn-regen-all').style.display = 'none';
            document.getElementById('dsb-btn-cancel').style.display = '';
            document.getElementById('dsb-logs').style.display = '';

            const globalSeed = parseInt(document.getElementById('dsb-global-seed').value);
            const perSeeds = dsbRows.map(r => r.seed !== '' && r.seed !== undefined ? parseInt(r.seed) : -1);

            try {
                await API.post('/api/dataset_builder/generate_batch', {
                    name,
                    description: rootDesc,
                    samples: dsbRows.map(r => ({ emotion: r.emotion || '', text: r.text || '' })),
                    indices,
                    global_seed: !isNaN(globalSeed) && globalSeed >= 0 ? globalSeed : -1,
                    seeds: perSeeds,
                });

                // Start polling
                dsbStartPolling(name);
            } catch (e) {
                showToast('Batch generation failed: ' + e.message, 'error');
                dsbStopBatch();
            }
        };

        function dsbStartPolling(name) {
            if (dsbPolling) clearInterval(dsbPolling);
            dsbPolling = setInterval(() => dsbPollStatus(name), 2000);
        }

        async function dsbPollStatus(name, silent = false) {
            try {
                const result = await API.get(`/api/dataset_builder/status/${encodeURIComponent(name)}`);
                const serverSamples = result.samples || [];

                // Merge server state into local rows, creating missing rows
                const changed = [];
                let added = false;
                serverSamples.forEach((s, i) => {
                    if (i < dsbRows.length) {
                        const oldStatus = dsbRows[i].status;
                        const oldAudio = dsbRows[i].audio_url;
                        if (s.status) dsbRows[i].status = s.status;
                        if (s.audio_url) dsbRows[i].audio_url = s.audio_url;
                        if (dsbRows[i].status !== oldStatus || dsbRows[i].audio_url !== oldAudio) changed.push(i);
                    } else {
                        dsbRows.push({
                            emotion: s.description || '',
                            text: s.text || '',
                            seed: s.seed ?? '',
                            status: s.status || 'pending',
                            audio_url: s.audio_url || null
                        });
                        added = true;
                    }
                });

                if (added) {
                    dsbRenderTable();
                } else if (changed.length > 0) {
                    dsbRenderTable(changed);
                }

                // Update logs
                if (result.logs && result.logs.length > 0) {
                    const logsEl = document.getElementById('dsb-logs');
                    logsEl.style.display = '';
                    logsEl.innerText = result.logs.join('\n');
                    logsEl.scrollTop = logsEl.scrollHeight;
                }

                // Resume polling if server is still running (e.g. after page reload)
                if (result.running && !dsbBatchRunning) {
                    dsbBatchRunning = true;
                    dsbStartPolling(name);
                    document.getElementById('dsb-btn-gen-all').style.display = 'none';
                    document.getElementById('dsb-btn-regen-all').style.display = 'none';
                    document.getElementById('dsb-btn-cancel').style.display = '';
                }

                // Check if batch is done
                if (!result.running && dsbBatchRunning) {
                    dsbStopBatch();
                }

                // If not running and this was a one-time check, stop polling
                if (!result.running && silent && dsbPolling) {
                    clearInterval(dsbPolling);
                    dsbPolling = null;
                }
            } catch (e) {
                if (!silent) console.error('Poll error:', e);
                // Status endpoint may 404 if no state.json yet  ignore silently
                if (silent && dsbPolling) {
                    clearInterval(dsbPolling);
                    dsbPolling = null;
                }
            }
        }

        function dsbStopBatch() {
            dsbBatchRunning = false;
            if (dsbPolling) { clearInterval(dsbPolling); dsbPolling = null; }
            document.getElementById('dsb-btn-gen-all').style.display = '';
            document.getElementById('dsb-btn-regen-all').style.display = '';
            document.getElementById('dsb-btn-cancel').style.display = 'none';
            dsbRenderTable();
        }

        window.dsbCancel = async () => {
            try {
                await API.post('/api/dataset_builder/cancel', {});
            } catch (e) { console.error('Cancel error:', e); }
        };

        // Import / Export
        window.dsbImport = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!Array.isArray(data)) throw new Error('Expected JSON array');
                    dsbRows = data.map(item => ({
                        emotion: item.emotion || item.instruct || '',
                        text: item.text || '',
                        seed: item.seed ?? '',
                        status: 'pending',
                        audio_url: null,
                    }));
                    dsbRenderTable();
                    dsbSaveRows();
                } catch (err) {
                    showToast('Import failed: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';  // reset file input
        };

        window.dsbExport = () => {
            const data = dsbRows.map(r => {
                const entry = { emotion: r.emotion, text: r.text };
                if (r.seed !== '' && r.seed !== undefined) entry.seed = parseInt(r.seed);
                return entry;
            });
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const name = dsbCurrentProject || 'dataset';
            a.download = `${name}_script.json`;
            a.click();
            URL.revokeObjectURL(url);
        };

        // Save as training dataset
        window.dsbSave = async () => {
            const name = dsbCurrentProject;
            if (!name) { showToast('Select or create a project first.', 'warning'); return; }

            const doneSamples = dsbRows.filter(r => r.status === 'done');
            if (doneSamples.length === 0) { showToast('No completed samples to save. Generate some first.', 'warning'); return; }

            const refIdx = parseInt(document.getElementById('dsb-ref-select').value) || 0;

            if (!await showConfirm(`Save "${name}" as training dataset with ${doneSamples.length} samples?`)) return;

            const statusEl = document.getElementById('dsb-save-status');
            statusEl.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';

            try {
                const result = await API.post('/api/dataset_builder/save', {
                    name,
                    ref_index: refIdx,
                });
                statusEl.innerHTML = `<span class="text-success"><i class="fas fa-check me-1"></i>Saved! ${result.sample_count} samples.</span>`;
            } catch (e) {
                statusEl.innerHTML = `<span class="text-danger">Save failed: ${e.message}</span>`;
            }
        };

        // Persist on input changes
        document.getElementById('dsb-description')?.addEventListener('input', dsbSaveForm);
        document.getElementById('dsb-global-seed')?.addEventListener('input', dsbSaveForm);

        // Init
        loadConfig();
        loadVoices();
        loadSavedScripts();
        loadDesignedVoices();
        dsbLoadProjects();
    </script>
</body>
</html>
