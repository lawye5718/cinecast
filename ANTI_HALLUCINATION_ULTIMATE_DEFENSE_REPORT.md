# 🛡️ 终极防幻觉方案执行报告

## 一、方案概述

**目标**：从根源阻止 TTS 自回归模型的幻觉（复读/不停止）现象。  
**核心思路**：既然无法在模型"发疯"时中途打断，那就不给它任何"发疯"的机会。  
**修改文件**：`modules/mlx_tts_engine.py` — `render_dry_chunk` 方法

---

## 二、变更详情

### 2.1 修改内容：`modules/mlx_tts_engine.py`

#### 🌟 终极暴力清洗：消灭一切导致复读的特殊符号

在 `render_dry_chunk` 方法的 `try` 块中，将原有的 3 条清洗规则扩展为 5 条，新增了英文破折号和波浪号的处理：

| 规则 | 正则表达式 | 替换为 | 说明 |
|------|-----------|--------|------|
| 1 | `[…]+` | `。` | 中文省略号 → 句号 |
| 2 | `\.{3,}` | `。` | 英文省略号（3个或更多点）→ 句号 |
| 3 | `[—]+` | `，` | 中文破折号 → 逗号 |
| 4 | `[-]{2,}` | `，` | **新增** 英文破折号（2个或更多连字符）→ 逗号 |
| 5 | `[~～]+` | `。` | **新增** 波浪号（英文/中文）→ 句号 |

#### 🌟 绝杀防御：纯标点符号检测与静音音频生成

在标点符号清洗和补全之后，新增了一道"绝杀"检查：

1. 使用正则表达式 `[。，！？；、""''（）《》,.!?;:'"()-\s]` 过滤掉所有标点符号和空白字符
2. 如果过滤后的 `pure_text` 为空（即原文仅由标点/特殊符号组成，没有实际文字内容），则：
   - 记录警告日志
   - 生成 0.5 秒的静音 WAV 文件（`np.zeros`），避免后续混音流程因找不到文件而报错
   - 直接返回 `True`，跳过大模型推理

### 2.2 修改内容：`tests/test_tts_punctuation_guard.py`

#### 新增测试辅助函数

- `_is_pure_punctuation(text)` — 镜像 `render_dry_chunk` 中的纯标点检测逻辑

#### 更新 `_apply_text_cleaning` 函数

- 新增英文破折号 `[-]{2,}` 和波浪号 `[~～]+` 的清洗规则，与源码保持一致

#### 新增测试类：`TestUltimateDefenseCleaning`（7 个测试用例）

| 测试用例 | 验证内容 |
|---------|---------|
| `test_double_english_dash_replaced` | `--` 被替换为 `，` |
| `test_triple_english_dash_replaced` | `---` 被替换为 `，` |
| `test_single_english_dash_not_replaced` | 单个 `-` 不被替换 |
| `test_chinese_tilde_replaced` | `～` 被替换为 `。` |
| `test_english_tilde_replaced` | `~` 被替换为 `。` |
| `test_multiple_tildes_replaced` | 多个 `~~~` / `～～～` 被合并为单个 `。` |
| `test_mixed_tildes_replaced` | 混合 `~～~` 被合并为单个 `。` |

#### 新增测试类：`TestPurePunctuationDefense`（7 个测试用例）

| 测试用例 | 验证内容 |
|---------|---------|
| `test_only_ellipsis_is_pure_punctuation` | `……` 被检测为纯标点 |
| `test_only_em_dash_is_pure_punctuation` | `——` 被检测为纯标点 |
| `test_only_tildes_is_pure_punctuation` | `~~~` / `～～～` 被检测为纯标点 |
| `test_only_punctuation_marks` | `，。！？` 被检测为纯标点 |
| `test_empty_string_is_pure_punctuation` | 空字符串被检测为纯标点 |
| `test_real_text_not_pure_punctuation` | 含有实际文字的文本不被误判 |
| `test_mixed_text_and_punctuation_not_pure` | 文字+标点混合文本不被误判 |

#### 更新测试类：`TestSourceCodeGuard`

- `test_aggressive_cleaning_in_source`：新增对 `[-]{2,}` 和 `[~～]+` 正则表达式存在性的检查
- **新增** `test_pure_punctuation_guard_in_source`：验证 `pure_text` 变量和 `np.zeros` 静音生成代码存在于源码中

---

## 三、测试结果

```
48 passed in 0.08s
```

所有 48 个测试用例全部通过，包括：
- 15 个原有标点符号守卫测试
- 10 个原有暴力清洗测试
- 7 个新增终极防御清洗测试
- 7 个新增纯标点检测测试
- 4 个预览模式截断测试
- 5 个源码守卫测试（含 2 个更新/新增）

---

## 四、防御机制全景图

```
输入文本
  │
  ▼
┌─────────────────────────────┐
│  第一层：暴力清洗             │
│  …… → 。                    │
│  ... → 。                   │
│  —— → ，                    │
│  -- → ，    ← 新增           │
│  ~～ → 。   ← 新增           │
└─────────────────────────────┘
  │
  ▼
┌─────────────────────────────┐
│  第二层：标点补全             │
│  末尾无闭合标点 → 补"。"      │
└─────────────────────────────┘
  │
  ▼
┌─────────────────────────────┐
│  第三层：绝杀防御  ← 新增     │
│  检测是否只剩标点无实际文字    │
│  是 → 生成 0.5s 静音音频     │
│  否 → 正常送入模型推理        │
└─────────────────────────────┘
  │
  ▼
正常 TTS 推理 / 0.5s 静音
```

---

## 五、总结

本次变更通过三层递进防御机制，从根源上阻止了 TTS 自回归模型因特殊符号（省略号、破折号、波浪号等）触发的复读/不停止幻觉问题：

1. **暴力清洗层**：将所有已知的"危险"符号替换为安全的标点
2. **标点补全层**：确保文本以标准闭合标点结尾，引导模型正确停止
3. **绝杀防御层**：对清洗后仅剩标点的文本，直接生成静音音频，完全绕过模型推理

变更范围精确可控，仅涉及 `render_dry_chunk` 方法的 `try` 块前半部分，不影响模型推理、音频写入、内存管理等后续逻辑。
